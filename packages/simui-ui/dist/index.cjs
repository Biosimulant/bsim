"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const e=require("react/jsx-runtime"),i=require("react"),Ve=require("react-markdown"),Ue=require("remark-gfm"),be=require("dagre"),F=require("@xyflow/react");function He(s){const t=s.replace(/\/$/,"");async function n(a){const d=await fetch(`${t}${a}`);if(!d.ok)throw new Error(`GET ${a} failed: ${d.status}`);return d.json()}async function o(a,d){const g=await fetch(`${t}${a}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(d)});if(!g.ok)throw new Error(`POST ${a} failed: ${g.status}`);return g.json()}async function l(a,d){const g=await fetch(`${t}${a}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(d)});if(!g.ok)throw new Error(`PUT ${a} failed: ${g.status}`);return g.json()}function c(a,d){const g=new EventSource(`${t}/api/stream`);return g.onmessage=w=>{try{const j=JSON.parse(w.data);a(j)}catch(j){console.error("Failed to parse SSE message:",j)}},g.onerror=w=>{d&&d(w)},{close:()=>g.close()}}return{spec:()=>n("/api/spec"),status:()=>n("/api/status"),state:()=>n("/api/state"),events:(a,d=200)=>n(`/api/events?${new URLSearchParams({...a!=null?{since_id:String(a)}:{},limit:String(d)}).toString()}`),visuals:()=>n("/api/visuals"),snapshot:()=>n("/api/snapshot"),run:(a,d,g)=>o("/api/run",{duration:a,tick_dt:d,...g||{}}),pause:()=>o("/api/pause",{}),resume:()=>o("/api/resume",{}),reset:()=>o("/api/reset",{}),subscribeSSE:c,editor:{getModules:()=>n("/api/editor/modules"),getConfig:a=>n(`/api/editor/config?path=${encodeURIComponent(a)}`),getCurrent:()=>n("/api/editor/current"),saveConfig:(a,d)=>l("/api/editor/config",{path:a,graph:d}),applyConfig:(a,d)=>o("/api/editor/apply",{graph:a,save_path:d}),validate:a=>o("/api/editor/validate",a),layout:a=>o("/api/editor/layout",a),toYaml:a=>o("/api/editor/to-yaml",a),fromYaml:a=>o("/api/editor/from-yaml",{yaml:a}),listFiles:a=>n(`/api/editor/files${a?`?path=${encodeURIComponent(a)}`:""}`)}}}function Ye(){var n;return{baseUrl:((n=window.__BSIM_UI__)==null?void 0:n.mountPath)??""}}const Oe=i.createContext(null),qe=({api:s,children:t})=>{const n=i.useMemo(Ye,[]),o=i.useMemo(()=>s??He(n.baseUrl),[n.baseUrl,s]);return e.jsx(Oe.Provider,{value:o,children:t})};function xe(){const s=i.useContext(Oe);if(!s)throw new Error("useApi must be used within ApiProvider");return s}const Ie=i.createContext(null);function Ge({children:s}){const[t,n]=i.useState(null),[o,l]=i.useState(null),[c,a]=i.useState([]),[d,g]=i.useState([]),[w,j]=i.useState({duration:10,tick_dt:.1}),[v,b]=i.useState(new Set),h=i.useMemo(()=>({setSpec:n,setStatus:l,setVisuals:a,setEvents:g,appendEvent:A=>g(C=>[...C,A]),setControls:A=>j(C=>({...C,...A})),setControlsIfUnset:A=>j(C=>{const u={...C};for(const[S,R]of Object.entries(A)){const L=u[S];(!Object.prototype.hasOwnProperty.call(u,S)||L===void 0||L===""||typeof L=="number"&&!Number.isFinite(L))&&(u[S]=R)}return u}),setVisibleModules:b}),[]),p={spec:t,status:o,visuals:c,events:d,controls:w,visibleModules:v},m=i.useMemo(()=>({state:p,actions:h}),[t,o,c,d,w,v,h]);return e.jsx(Ie.Provider,{value:m,children:s})}function se(){const s=i.useContext(Ie);if(!s)throw new Error("useUi must be used within UiProvider");return s}function ve(){const{state:s}=se();return i.useMemo(()=>{var c;const t=Array.isArray((c=s.spec)==null?void 0:c.modules)?s.spec.modules:[],n=s.visuals.map(a=>a.module),o=[],l=new Set;for(const a of t)a&&!l.has(a)&&(o.push(a),l.add(a));for(const a of n)a&&!l.has(a)&&(o.push(a),l.add(a));return o},[s.spec,s.visuals])}function Ke(){const{state:s}=se();return i.useMemo(()=>{const t=new Map;for(const n of s.visuals){const o=t.get(n.module);o?t.set(n.module,[...o,...n.visuals||[]]):t.set(n.module,n.visuals||[])}return t},[s.visuals])}function me(s){return s.type==="number"}function ae(s){return s.type==="json"}function Fe(s){if(!Number.isFinite(s))return"—";const t=Math.max(0,s),n=Math.floor(t/3600),o=Math.floor(t%3600/60),l=Math.floor(t%60);return n>0?`${n}h ${o}m ${l}s`:o>0?`${o}m ${l}s`:`${l}s`}function Ee({id:s,title:t,summary:n,open:o,onToggle:l,children:c}){return e.jsxs("section",{className:`sidebar-panel ${o?"is-open":"is-closed"}`,children:[e.jsxs("button",{type:"button",className:"sidebar-panel-header",onClick:()=>l(s),"aria-expanded":o,children:[e.jsx("span",{className:`sidebar-panel-chevron ${o?"open":""}`,"aria-hidden":"true",children:"▸"}),e.jsx("span",{className:"sidebar-panel-title",children:t}),n&&e.jsx("span",{className:"sidebar-panel-summary",children:n})]}),o&&e.jsx("div",{className:"sidebar-panel-body",children:c})]})}function Xe(){var n;const{state:s}=se(),t=s.status;return t?t.error?e.jsxs("div",{className:"status-display",children:[e.jsx("div",{className:"status-badge status-error",children:"Error"}),e.jsx("div",{className:"status-message error",children:t.error.message})]}):t.running?e.jsxs("div",{className:"status-display",children:[e.jsx("div",{className:`status-badge ${t.paused?"status-paused":"status-running"}`,children:t.paused?"Paused":"Running"}),e.jsxs("div",{className:"status-info",children:["Ticks: ",((n=t.tick_count)==null?void 0:n.toLocaleString())||0]})]}):e.jsx("div",{className:"status-display",children:e.jsx("div",{className:"status-badge status-idle",children:"Idle"})}):e.jsx("div",{className:"status-display",children:e.jsx("div",{className:"status-badge status-unknown",children:"Unknown"})})}function Qe(){var k,N,I;const{state:s,actions:t}=se(),n=s.status,o=(k=s.spec)==null?void 0:k.capabilities,l=(o==null?void 0:o.controls)??!0;l&&(o==null||o.run),l&&(o==null||o.pauseResume),l&&(o==null||o.reset);const c=ve(),a=(((N=s.spec)==null?void 0:N.controls)||[]).filter(me),d=new Set(["wiring","wiring_layout","module_ports","models"]),g=(((I=s.spec)==null?void 0:I.controls)||[]).filter(ae).filter(y=>!d.has(y.name)),w=i.useCallback((y,T)=>t.setControls({[y]:T}),[t]),j=y=>{if(y===""||y===null||y===void 0)return Number.NaN;const T=typeof y=="number"?y:Number(String(y));return Number.isFinite(T)?T:Number.NaN},v=y=>{var T;return(T=a.find($=>$.name===y))==null?void 0:T.default};j(s.controls.duration??v("duration"));const b=j(s.controls.tick_dt??v("tick_dt")),h=j(n==null?void 0:n.tick_count)*b,p=new Set(["duration","tick_dt"]),m=a.filter(y=>p.has(y.name)),A=a.filter(y=>!p.has(y.name)),C=new Set(c),u=new Map,S=[];for(const y of A){const T=y.name.indexOf(".");if(T>0){const $=y.name.slice(0,T);if(C.has($)){const P=u.get($)||[];P.push(y),u.set($,P);continue}}S.push(y)}const R=Array.from(u.keys()),[L,W]=i.useState({});i.useEffect(()=>{R.length!==0&&W(y=>{const T={...y};for(const $ of R)$ in T||(T[$]=!1);return T})},[R.join("|")]);const[q,E]=i.useState(!1);return e.jsxs("div",{className:"controls",children:[m.length>0&&e.jsx("div",{className:"control-fields",children:m.map(y=>e.jsxs("div",{className:"control-field",children:[e.jsx("label",{htmlFor:`control-${y.name}`,className:"control-label",children:y.label||y.name}),e.jsx("input",{id:`control-${y.name}`,type:"number",className:"control-input",value:String(s.controls[y.name]??y.default),min:y.min,max:y.max,step:y.step??"any",onChange:T=>w(y.name,T.target.value),disabled:!!(n!=null&&n.running)||!l})]},y.name))}),u.size>0&&e.jsx("div",{className:"control-fields",children:Array.from(u.entries()).map(([y,T])=>e.jsxs("div",{className:"control-group",children:[e.jsxs("button",{type:"button",className:"control-group-header",onClick:()=>W($=>({...$,[y]:!$[y]})),"aria-expanded":L[y]??!1,children:[e.jsx("span",{className:`control-group-chevron ${L[y]?"open":""}`,"aria-hidden":"true",children:"▸"}),e.jsx("span",{className:"control-group-title",children:y}),e.jsxs("span",{className:"control-group-summary",children:[T.length," params"]})]}),L[y]&&e.jsx("div",{className:"control-group-body",children:e.jsx("div",{className:"control-fields",style:{marginTop:0},children:T.map($=>{const P=$.name.indexOf("."),K=P>0?$.name.slice(P+1):$.name;return e.jsxs("div",{className:"control-field",children:[e.jsx("label",{htmlFor:`control-${$.name}`,className:"control-label",children:$.label||K}),e.jsx("input",{id:`control-${$.name}`,type:"number",className:"control-input",value:String(s.controls[$.name]??$.default),min:$.min,max:$.max,step:$.step??"any",onChange:Q=>w($.name,Q.target.value),disabled:!!(n!=null&&n.running)||!l})]},$.name)})})})]},y))}),S.length>0&&e.jsx("div",{className:"control-fields",children:S.map(y=>e.jsxs("div",{className:"control-field",children:[e.jsx("label",{htmlFor:`control-${y.name}`,className:"control-label",children:y.label||y.name}),e.jsx("input",{id:`control-${y.name}`,type:"number",className:"control-input",value:String(s.controls[y.name]??y.default),min:y.min,max:y.max,step:y.step??"any",onChange:T=>w(y.name,T.target.value),disabled:!!(n!=null&&n.running)||!l})]},y.name))}),g.length>0&&e.jsxs("div",{className:"control-group",children:[e.jsxs("button",{type:"button",className:"control-group-header",onClick:()=>E(y=>!y),"aria-expanded":q,children:[e.jsx("span",{className:`control-group-chevron ${q?"open":""}`,"aria-hidden":"true",children:"▸"}),e.jsx("span",{className:"control-group-title",children:"Advanced (JSON)"}),e.jsxs("span",{className:"control-group-summary",children:[g.length," fields"]})]}),q&&e.jsx("div",{className:"control-group-body",children:e.jsx("div",{className:"control-fields",children:g.map(y=>e.jsxs("div",{className:"control-field",children:[e.jsx("label",{htmlFor:`control-${y.name}`,className:"control-label",children:y.label||y.name}),e.jsx("textarea",{id:`control-${y.name}`,className:"control-input",value:String(s.controls[y.name]??y.default),placeholder:y.placeholder,rows:y.rows??6,onChange:T=>w(y.name,T.target.value),disabled:!!(n!=null&&n.running)||!l})]},y.name))})})]}),e.jsx("div",{className:"control-derived",children:(n==null?void 0:n.running)&&Number.isFinite(h)&&e.jsxs("div",{className:"control-derived-row",children:[e.jsx("span",{className:"control-derived-label",children:"Sim time"}),e.jsx("span",{className:"control-derived-value",children:Fe(h)})]})})]})}function Ze(){const{state:s,actions:t}=se(),n=ve();i.useEffect(()=>{n.length>0&&s.visibleModules.size===0&&t.setVisibleModules(new Set(n))},[n,s.visibleModules.size,t]);const o=i.useCallback(a=>{const d=new Set(s.visibleModules);d.has(a)?d.delete(a):d.add(a),t.setVisibleModules(d)},[s.visibleModules,t]),l=i.useCallback(()=>t.setVisibleModules(new Set(n)),[n,t]),c=i.useCallback(()=>t.setVisibleModules(new Set),[t]);return n.length===0?e.jsx("div",{className:"modules",children:e.jsx("div",{className:"empty-state",children:e.jsx("p",{children:"No modules available"})})}):e.jsxs("div",{className:"modules",children:[e.jsx("div",{className:"module-list",children:n.map(a=>e.jsxs("label",{className:"module-item",children:[e.jsx("input",{type:"checkbox",className:"module-checkbox",checked:s.visibleModules.has(a),onChange:()=>o(a)}),e.jsx("span",{className:"module-name",children:a})]},a))}),e.jsxs("div",{className:"module-actions",children:[e.jsx("button",{type:"button",className:"btn btn-small",onClick:l,children:"Show All"}),e.jsx("button",{type:"button",className:"btn btn-small",onClick:c,children:"Hide All"})]})]})}function et(s){const{state:t}=se(),o=ve().length,l=t.visibleModules.size||o,[c,a]=i.useState({controls:!1,status:!1,modules:!1}),d=i.useCallback(v=>{a(b=>({...b,[v]:!b[v]}))},[]),g=i.useMemo(()=>{var b;const v=t.status;return v?v.error?"Error":v.running?`${v.paused?"Paused":"Running"} · Ticks: ${((b=v.tick_count)==null?void 0:b.toLocaleString())||0}`:"Idle":"Unknown"},[t.status]),w=i.useMemo(()=>{var h;const b=(Array.isArray((h=t.spec)==null?void 0:h.controls)?t.spec.controls:[]).filter(p=>me(p)||ae(p)).length;return b?`${b} controls`:"No controls"},[t.spec]),j=i.useMemo(()=>o===0?"No modules":`${l}/${o} shown`,[l,o]);return e.jsx("div",{className:"sidebar",children:e.jsxs("div",{className:"sidebar-content",children:[e.jsx(Ee,{id:"status",title:"Status",summary:g,open:c.status,onToggle:d,children:e.jsx(Xe,{})}),e.jsx(Ee,{id:"controls",title:"Controls",summary:w,open:c.controls,onToggle:d,children:e.jsx(Qe,{})}),e.jsx(Ee,{id:"modules",title:"Modules",summary:j,open:c.modules,onToggle:d,children:e.jsx(Ze,{})}),e.jsx(tt,{...s})]})})}function tt({onRun:s,onPause:t,onResume:n,onReset:o}){var m,A;const{state:l}=se(),c=l.status,d=(Array.isArray((m=l.spec)==null?void 0:m.controls)?l.spec.controls:[]).find(C=>me(C)&&C.name==="duration"),g=d&&me(d)?d.default:void 0,w=(()=>{const C=l.controls.duration??g,u=typeof C=="number"?C:Number(String(C));return Number.isFinite(u)?u:NaN})(),j=(A=l.spec)==null?void 0:A.capabilities,v=(j==null?void 0:j.controls)??!0,b=v&&((j==null?void 0:j.run)??!0),h=v&&((j==null?void 0:j.pauseResume)??!0),p=v&&((j==null?void 0:j.reset)??!0);return e.jsxs("div",{className:"sidebar-actions",children:[e.jsxs("div",{className:"sidebar-actions-row",children:[e.jsx("div",{className:"sidebar-actions-label",children:"Duration"}),e.jsx("div",{className:"sidebar-actions-value",children:Number.isFinite(w)?Fe(w):"—"})]}),b&&e.jsx("button",{type:"button",className:"btn btn-primary",onClick:s,disabled:!!(c!=null&&c.running),children:"Run Simulation"}),h&&(c==null?void 0:c.running)&&e.jsx("button",{type:"button",className:"btn btn-secondary",onClick:c.paused?n:t,children:c.paused?"Resume":"Pause"}),p&&e.jsx("button",{type:"button",className:"btn btn-outline",onClick:o,children:"Reset"})]})}function st({data:s,isFullscreen:t}){const g=(s==null?void 0:s.series)||[],{xMin:w,xMax:j,yMin:v,yMax:b}=i.useMemo(()=>{let u=0,S=1,R=0,L=1;for(const W of g){const q=Array.isArray(W==null?void 0:W.points)?W.points:[];for(const E of q){const k=Number(E==null?void 0:E[0])||0,N=Number(E==null?void 0:E[1])||0;k<u&&(u=k),k>S&&(S=k),N<R&&(R=N),N>L&&(L=N)}}return{xMin:u,xMax:S<=u?u+1:S,yMin:R,yMax:L<=R?R+1:L}},[g]),h=u=>50+(u-w)/(j-w)*450,p=u=>20+(1-(u-v)/(b-v))*180,m=u=>(u.points||[]).map(S=>`${h(S[0])},${p(S[1])}`).join(" "),A=(u,S,R=5)=>Array.from({length:R+1},(L,W)=>u+W*(S-u)/R),C=t?{width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center"}:{};return e.jsx("div",{style:C,className:t?"fullscreen-renderer":"",children:e.jsxs("svg",{viewBox:"0 0 520 240",width:"100%",height:t?"100%":240,preserveAspectRatio:t?"xMidYMid meet":void 0,children:[e.jsx("line",{x1:50,y1:200,x2:500,y2:200,className:"axis"}),e.jsx("line",{x1:50,y1:20,x2:50,y2:200,className:"axis"}),A(w,j,5).map(u=>e.jsxs("g",{children:[e.jsx("line",{x1:h(u),y1:200,x2:h(u),y2:204,className:"tick"}),e.jsx("text",{x:h(u),y:234,className:"ticklbl",textAnchor:"middle",children:u.toFixed(2)})]},`tx-${u}`)),A(v,b,4).map(u=>e.jsxs("g",{children:[e.jsx("line",{x1:46,y1:p(u),x2:50,y2:p(u),className:"tick"}),e.jsx("text",{x:44,y:p(u)+3,className:"ticklbl",textAnchor:"end",children:u.toFixed(2)})]},`ty-${u}`)),g.map((u,S)=>e.jsx("polyline",{points:m(u),fill:"none",stroke:S===0?"var(--primary)":S===1?"var(--danger)":"var(--accent)",strokeWidth:2},S))]})})}function nt({data:s,isFullscreen:t}){const g=(s==null?void 0:s.items)||[],w=i.useMemo(()=>{let m=1;for(const A of g){const C=Number((A==null?void 0:A.value)||0);Number.isFinite(C)&&C>m&&(m=C)}return m},[g]),j=(m,A)=>50+(m+.5)*450/Math.max(1,A),v=m=>Math.max(8,.8*450/Math.max(1,m)),b=m=>20+(1-Math.min(1,Math.max(0,m/w)))*180,h=(m=4)=>Array.from({length:m+1},(A,C)=>C*w/m),p=t?{width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center"}:{};return e.jsx("div",{style:p,children:e.jsxs("svg",{viewBox:"0 0 520 240",width:"100%",height:t?"100%":240,preserveAspectRatio:t?"xMidYMid meet":void 0,children:[e.jsx("line",{x1:50,y1:200,x2:500,y2:200,className:"axis"}),e.jsx("line",{x1:50,y1:20,x2:50,y2:200,className:"axis"}),h(4).map(m=>e.jsxs("g",{children:[e.jsx("line",{x1:46,y1:b(m),x2:50,y2:b(m),className:"tick"}),e.jsx("text",{x:44,y:b(m)+3,className:"ticklbl",textAnchor:"end",children:m.toFixed(0)})]},`ty-${m}`)),g.map((m,A)=>e.jsxs("g",{children:[e.jsx("rect",{x:j(A,g.length)-v(g.length)/2,y:b(m.value),width:v(g.length),height:200-b(m.value),className:"bar"}),e.jsx("text",{x:j(A,g.length),y:234,className:"xlbl",textAnchor:"middle",children:m.label})]},A))]})})}function ot({data:s,isFullscreen:t}){var g,w,j,v;const n=(g=s.columns)!=null&&g.length?s.columns:(w=s.items)!=null&&w.length?Object.keys(s.items[0]):[],o=(j=s.rows)!=null&&j.length?s.rows:((v=s.items)==null?void 0:v.map(b=>n.map(h=>b[h])))||[],l=t?{width:"100%",height:"100%",overflow:"auto"}:{overflow:"auto"},c=t?{width:"100%",borderCollapse:"collapse",fontSize:"16px"}:{width:"100%",borderCollapse:"collapse"},a=t?{textAlign:"left",borderBottom:"1px solid var(--border)",padding:"12px 16px",fontWeight:600,fontSize:"18px"}:{textAlign:"left",borderBottom:"1px solid var(--border)",padding:8,fontWeight:600},d=t?{borderBottom:"1px solid var(--border)",padding:"10px 16px",fontSize:"16px"}:{borderBottom:"1px solid var(--border)",padding:"6px 8px"};return e.jsxs("div",{className:"table-container",style:l,children:[e.jsxs("table",{style:c,children:[e.jsx("thead",{children:e.jsx("tr",{children:n.map(b=>e.jsx("th",{style:a,children:b},b))})}),e.jsx("tbody",{children:o.map((b,h)=>e.jsx("tr",{children:b.map((p,m)=>e.jsx("td",{style:d,children:String(p)},m))},h))})]}),(!n||n.length===0)&&e.jsx("div",{className:"empty",children:"No table data"})]})}function rt({data:s,isFullscreen:t}){if(!(s!=null&&s.src))return e.jsx("div",{className:"empty-state",children:e.jsx("p",{children:"No image"})});const{src:n,alt:o,width:l,height:c}=s;return t?e.jsx("div",{style:{width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center",overflow:"auto"},children:e.jsx("img",{src:n,alt:o||"image",style:{maxWidth:"100%",maxHeight:"100%",objectFit:"contain"}})}):e.jsx("div",{style:{overflow:"auto"},children:e.jsx("img",{src:n,alt:o||"image",width:l,height:c,style:{maxWidth:"100%"}})})}function it({data:s,isFullscreen:t}){const n=s.nodes||[],o=s.edges||[],l=520,c=300,a=110,d=l/2,g=c/2,w=i.useMemo(()=>{const v=Math.max(1,n.length),b=new Map;return n.forEach((h,p)=>{const m=2*Math.PI*p/v;b.set(h.id,{x:d+a*Math.cos(m),y:g+a*Math.sin(m)})}),b},[JSON.stringify(n)]),j=t?{width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center"}:{};return e.jsx("div",{style:j,children:e.jsxs("svg",{viewBox:`0 0 ${l} ${c}`,width:"100%",height:t?"100%":c,preserveAspectRatio:t?"xMidYMid meet":void 0,children:[o.map((v,b)=>{const h=w.get(v.source),p=w.get(v.target);return!h||!p?null:e.jsx("line",{x1:h.x,y1:h.y,x2:p.x,y2:p.y,stroke:"#64748b",strokeWidth:1},b)}),n.map((v,b)=>{const h=w.get(v.id);return h?e.jsxs("g",{children:[e.jsx("circle",{cx:h.x,cy:h.y,r:14,fill:"#22d3ee"}),e.jsx("text",{x:h.x,y:h.y+4,fontSize:10,textAnchor:"middle",fill:"#0f172a",children:v.id})]},v.id):null})]})})}const at={timeseries:st,bar:nt,table:ot,image:rt,graph:it};function lt({isFullscreen:s,onClick:t}){return e.jsx("button",{className:"btn btn-small btn-outline fullscreen-btn",onClick:t,title:s?"Exit fullscreen":"Fullscreen",children:s?e.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"})}):e.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"})})})}function ct({isActive:s,onClick:t}){return e.jsx("button",{className:`btn btn-small btn-outline info-btn ${s?"active":""}`,onClick:t,title:s?"Hide description":"Show description",children:e.jsxs("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10"}),e.jsx("path",{d:"M12 16v-4"}),e.jsx("path",{d:"M12 8h.01"})]})})}function dt({visual:s,index:t}){var h;const[n,o]=i.useState(!1),[l,c]=i.useState(!1),a=at[s.render],d=i.useCallback(()=>{o(p=>!p)},[]),g=i.useCallback(()=>{c(p=>!p)},[]),w=i.useCallback(p=>{p.key==="Escape"&&n&&o(!1)},[n]);if(!a)return e.jsxs("div",{className:"visualization-card error",children:[e.jsxs("div",{className:"card-header",children:[e.jsx("h4",{className:"card-title",children:"Unknown Renderer"}),e.jsx("span",{className:"card-type error",children:s.render})]}),e.jsx("div",{className:"card-content",children:e.jsx("div",{className:"error-message",children:e.jsxs("p",{children:['Renderer type "',s.render,'" is not supported.']})})})]});const j=((h=s.data)==null?void 0:h.title)||`${s.render.charAt(0).toUpperCase()+s.render.slice(1)} #${t+1}`,v=!!s.description,b=e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"card-header",children:[e.jsx("h4",{className:"card-title",children:j}),e.jsxs("div",{className:"card-actions",children:[e.jsx("span",{className:"card-type",children:s.render}),v&&e.jsx(ct,{isActive:l,onClick:g}),e.jsx(lt,{isFullscreen:n,onClick:d})]})]}),l&&s.description&&e.jsx("div",{className:"card-description",children:s.description}),e.jsx("div",{className:"card-content",children:e.jsx(a,{data:s.data,isFullscreen:n})})]});return n?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"visualization-card placeholder"}),e.jsx("div",{className:"fullscreen-overlay",onClick:d,onKeyDown:w,tabIndex:0,children:e.jsx("div",{className:"fullscreen-card",onClick:p=>p.stopPropagation(),children:b})})]}):e.jsx("div",{className:"visualization-card",children:b})}function Be({moduleName:s,visualCount:t}){return e.jsx("header",{className:"module-header",children:e.jsxs("div",{className:"module-info",children:[e.jsx("h3",{className:"module-title",children:s}),e.jsxs("span",{className:"module-meta",children:[t," visualization",t!==1?"s":""]})]})})}function ut({moduleName:s,visuals:t}){return!t||t.length===0?e.jsxs("div",{className:"module-visuals",children:[e.jsx(Be,{moduleName:s,visualCount:0}),e.jsx("div",{className:"empty-state",children:e.jsx("p",{children:"No visualizations available for this module"})})]}):e.jsxs("div",{className:"module-visuals",children:[e.jsx(Be,{moduleName:s,visualCount:t.length}),e.jsx("div",{className:"visualizations-grid",children:t.map((n,o)=>e.jsx(dt,{visual:n,index:o},`${s}-${n.render}-${o}`))})]})}const pt=i.memo(ut);function Te({description:s}){const[t,n]=i.useState(!1);if(!s)return null;const o=s.length>300||s.split(`
`).length>5;return e.jsxs("div",{className:`description-panel ${t?"expanded":"collapsed"}`,children:[e.jsxs("div",{className:"description-header",onClick:()=>o&&n(!t),children:[e.jsxs("div",{className:"description-title",children:[e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"}),e.jsx("polyline",{points:"14 2 14 8 20 8"}),e.jsx("line",{x1:"16",y1:"13",x2:"8",y2:"13"}),e.jsx("line",{x1:"16",y1:"17",x2:"8",y2:"17"}),e.jsx("polyline",{points:"10 9 9 9 8 9"})]}),e.jsx("span",{children:"About this Simulation"})]}),o&&e.jsxs("button",{className:"expand-btn",onClick:l=>{l.stopPropagation(),n(!t)},children:[t?e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("polyline",{points:"18 15 12 9 6 15"})}):e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("polyline",{points:"6 9 12 15 18 9"})}),e.jsx("span",{children:t?"Collapse":"Expand"})]})]}),e.jsx("div",{className:"description-content",children:e.jsx(Ve,{remarkPlugins:[Ue],children:s})})]})}const pe="__new__";function je(s){const t=s.indexOf(".");return t<=0||t>=s.length-1?null:{module:s.slice(0,t),port:s.slice(t+1)}}function Je(s){if(!Array.isArray(s))throw new Error("Wiring must be a JSON array.");return s.filter(t=>t&&typeof t=="object")}function mt(s,t,n,o,l){const c=new Map,a=new Map,d=new Set([...t,...Object.keys(n||{})]);for(const[h,p]of Object.entries(n||{})){c.has(h)||c.set(h,new Set),a.has(h)||a.set(h,new Set);for(const m of p.outputs||[])c.get(h).add(String(m));for(const m of p.inputs||[])a.get(h).add(String(m))}const g=[];let w=0;for(const h of s){const p=typeof h.from=="string"?h.from:"",m=h.to??h.targets,A=typeof m=="string"?[m]:Array.isArray(m)?m:[],C=je(p);if(C){d.add(C.module),c.has(C.module)||c.set(C.module,new Set),c.get(C.module).add(C.port);for(const u of A){if(typeof u!="string")continue;const S=je(u);S&&(d.add(S.module),a.has(S.module)||a.set(S.module,new Set),a.get(S.module).add(S.port),w+=1,g.push({id:`w-${w}-${p}->${u}`,source:C.module,sourceHandle:C.port,target:S.module,targetHandle:S.port,type:"smoothstep",style:{stroke:"#6b7280",strokeWidth:2}}))}}}for(const h of o)d.delete(h);const j=new Map(l.map(h=>[h.id,h])),v=Array.from(d).map(h=>{const p=j.get(h),m=Array.from(a.get(h)??[]).sort(),A=Array.from(c.get(h)??[]).sort();return{id:h,type:"wiringNode",position:(p==null?void 0:p.position)??{x:0,y:0},data:{label:h,inputs:m,outputs:A}}}),b=v.length>0&&v.every(h=>h.position.x===0&&h.position.y===0);return{nodes:v,edges:g,needsLayout:b}}function De(s,t){const n=new be.graphlib.Graph;n.setDefaultEdgeLabel(()=>({}));const o=220,l=140;n.setGraph({rankdir:"LR",nodesep:40,ranksep:80});for(const c of s)n.setNode(c.id,{width:o,height:l});for(const c of t)n.setEdge(c.source,c.target);return be.layout(n),s.map(c=>{const a=n.node(c.id);return{...c,position:{x:a.x-o/2,y:a.y-l/2}}})}function ht(s){const t=Je(s),n=[];let o=0;for(const l of t){const c=typeof l.from=="string"?l.from:"",a=l.to??l.targets,d=typeof a=="string"?[a]:Array.isArray(a)?a:[],g=je(c);if(g)for(const w of d){if(typeof w!="string")continue;const j=je(w);j&&(o+=1,n.push({id:`w-${o}-${c}->${w}`,source:g.module,sourceHandle:g.port,target:j.module,targetHandle:j.port,type:"smoothstep",style:{stroke:"#6b7280",strokeWidth:2}}))}}return n}function _e(s){const t=new Map;for(const n of s){if(!n.sourceHandle||!n.targetHandle)continue;const o=`${n.source}.${n.sourceHandle}`,l=`${n.target}.${n.targetHandle}`;t.has(o)||t.set(o,new Set),t.get(o).add(l)}return Array.from(t.entries()).sort(([n],[o])=>n.localeCompare(o)).map(([n,o])=>({from:n,to:Array.from(o).sort()}))}const xt=({data:s,selected:t})=>{const n=t?"var(--warning)":"var(--border)";return e.jsxs("div",{style:{background:"var(--surface-2)",border:`1px solid ${n}`,borderRadius:10,minWidth:200,boxShadow:t?"0 0 0 2px rgba(234, 179, 8, 0.3)":"var(--shadow)",overflow:"hidden",fontFamily:"ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, sans-serif"},children:[e.jsx("div",{style:{padding:"10px 12px",background:"var(--surface)",borderBottom:"1px solid var(--border)",fontWeight:700,fontSize:13,color:"var(--text)"},children:s.label}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",gap:10,padding:"10px 8px 12px 8px"},children:[e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:6},children:[e.jsx("div",{style:{paddingLeft:6,fontSize:11,color:"var(--muted)",fontWeight:600},children:"Inputs"}),s.inputs.length===0?e.jsx("div",{style:{paddingLeft:6,fontSize:11,color:"var(--muted)",fontStyle:"italic"},children:"none"}):s.inputs.map(o=>e.jsxs("div",{style:{position:"relative",paddingLeft:18},children:[e.jsx(F.Handle,{type:"target",position:F.Position.Left,id:o,style:{width:10,height:10,left:-5,background:"#6b7280",border:"2px solid var(--surface-2)"}}),e.jsx("span",{style:{fontSize:12,color:"var(--text)",whiteSpace:"nowrap"},children:o})]},o)),e.jsxs("div",{style:{position:"relative",paddingLeft:18,opacity:.85},children:[e.jsx(F.Handle,{type:"target",position:F.Position.Left,id:pe,style:{width:10,height:10,left:-5,background:"var(--warning)",border:"2px solid var(--surface-2)"}}),e.jsx("span",{style:{fontSize:12,color:"var(--muted)",whiteSpace:"nowrap"},children:"+ add"})]})]}),e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:6,alignItems:"flex-end"},children:[e.jsx("div",{style:{paddingRight:6,fontSize:11,color:"var(--muted)",fontWeight:600},children:"Outputs"}),s.outputs.length===0?e.jsx("div",{style:{paddingRight:6,fontSize:11,color:"var(--muted)",fontStyle:"italic"},children:"none"}):s.outputs.map(o=>e.jsxs("div",{style:{position:"relative",paddingRight:18},children:[e.jsx("span",{style:{fontSize:12,color:"var(--text)",whiteSpace:"nowrap"},children:o}),e.jsx(F.Handle,{type:"source",position:F.Position.Right,id:o,style:{width:10,height:10,right:-5,background:"var(--primary)",border:"2px solid var(--surface-2)"}})]},o)),e.jsxs("div",{style:{position:"relative",paddingRight:18,opacity:.85},children:[e.jsx("span",{style:{fontSize:12,color:"var(--muted)",whiteSpace:"nowrap"},children:"+ add"}),e.jsx(F.Handle,{type:"source",position:F.Position.Right,id:pe,style:{width:10,height:10,right:-5,background:"var(--warning)",border:"2px solid var(--surface-2)"}})]})]})]})]})};function ft(){var B,_,H,Z;const s=xe(),{state:t,actions:n}=se(),o=i.useMemo(()=>{var x;return(((x=t.spec)==null?void 0:x.controls)??[]).find(f=>ae(f)&&f.name==="wiring")},[t.spec]),l=i.useMemo(()=>{var x;return(((x=t.spec)==null?void 0:x.controls)??[]).find(f=>ae(f)&&f.name==="wiring_layout")},[t.spec]),c=i.useMemo(()=>{var x;return(((x=t.spec)==null?void 0:x.controls)??[]).find(f=>ae(f)&&f.name==="module_ports")},[t.spec]),a=i.useMemo(()=>{var x;return(((x=t.spec)==null?void 0:x.controls)??[]).find(f=>ae(f)&&f.name==="models")},[t.spec]),[d,g]=i.useState(!1),[w,j]=i.useState(null),[v,b]=i.useState(!1),[h,p]=i.useState(""),[m,A]=i.useState(null),C=i.useRef(""),u=i.useRef(""),S=!!((B=t.status)!=null&&B.running),[R,L]=i.useState("simui:wiring:default");i.useEffect(()=>{let r=!0;return(async()=>{var f,z,D;try{const O=await s.state();if(!r)return;const U=(f=O==null?void 0:O.run)==null?void 0:f.id;if(typeof U=="string"&&U){L(`simui:wiring:run:${U}`);return}const Y=O==null?void 0:O.target,G=Y==null?void 0:Y.spaceId,oe=Y==null?void 0:Y.spaceCommit;if(typeof G=="string"&&G){L(`simui:wiring:draft:space:${G}:${oe||"head"}`);return}const te=Y==null?void 0:Y.modelId,ye=Y==null?void 0:Y.modelCommit;if(typeof te=="string"&&te){L(`simui:wiring:draft:model:${te}:${ye||"head"}`);return}const ie=((z=t.spec)==null?void 0:z.title)||"default";L(`simui:wiring:title:${ie}`)}catch{const O=((D=t.spec)==null?void 0:D.title)||"default";L(`simui:wiring:title:${O}`)}})(),()=>{r=!1}},[s,(_=t.spec)==null?void 0:_.title]);const W=i.useMemo(()=>{if(!o)return null;const r=t.controls.wiring;return r===void 0?String(o.default??"[]"):typeof r=="string"?r:String(r)},[t.controls.wiring,o]),q=i.useMemo(()=>{if(!l)return null;const r=t.controls.wiring_layout;return r===void 0?String(l.default??'{"version":1,"nodes":{},"hidden_modules":[]}'):typeof r=="string"?r:String(r)},[t.controls.wiring_layout,l]),E=i.useMemo(()=>{if(!c)return null;const r=t.controls.module_ports;return r===void 0?String(c.default??"{}"):typeof r=="string"?r:String(r)},[t.controls.module_ports,c]),k=i.useMemo(()=>{if(!a)return null;const r=t.controls.models;return r===void 0?String(a.default??"[]"):typeof r=="string"?r:String(r)},[t.controls.models,a]),N=i.useMemo(()=>{if(!E)return{};try{const r=JSON.parse(E);return!r||typeof r!="object"||Array.isArray(r)?{}:r}catch{return{}}},[E]),I=i.useRef(null);i.useEffect(()=>{if(!a||I.current)return;const r=String(a.default??"[]");try{const x=JSON.parse(r);if(!Array.isArray(x))return;const f=new Map;x.forEach((z,D)=>{if(!z||typeof z!="object")return;const O=String(z.alias??z.repo_full_name??z.repo??`module-${D+1}`);O&&f.set(O,z)}),I.current=f}catch{}},[a]);const y=i.useMemo(()=>{const r=new Map;if(!k)return r;try{const x=JSON.parse(k);if(!Array.isArray(x))return r;x.forEach((f,z)=>{if(!f||typeof f!="object")return;const D=String(f.alias??f.repo_full_name??f.repo??`module-${z+1}`);D&&r.set(D,f)})}catch{}return r},[k]),T=i.useMemo(()=>{if(!a)return null;const r=I.current;return r?Array.from(r.keys()).sort((x,f)=>x.localeCompare(f)):null},[a]),$=i.useMemo(()=>{const r={version:1,nodes:{},hidden_modules:[]};if(!q)return r;try{const x=JSON.parse(q);if(!x||typeof x!="object"||Array.isArray(x))return r;const f=x.nodes,z=x.hidden_modules;return{version:typeof x.version=="number"?x.version:1,nodes:f&&typeof f=="object"&&!Array.isArray(f)?f:{},hidden_modules:Array.isArray(z)?z.map(String):[]}}catch{return r}},[q]);i.useEffect(()=>{if(!o)return;const r={};if(t.controls.wiring===void 0){const x=(()=>{try{const f=localStorage.getItem(R);if(!f)return null;const z=JSON.parse(f);return!z||typeof z.wiring!="string"?null:z.wiring}catch{return null}})();r.wiring=x??String(o.default??"[]")}l&&t.controls.wiring_layout===void 0&&(r.wiring_layout=String(l.default??'{"version":1,"nodes":{},"hidden_modules":[]}')),c&&t.controls.module_ports===void 0&&(r.module_ports=String(c.default??"{}")),a&&t.controls.models===void 0&&(r.models=String(a.default??"[]")),Object.keys(r).length>0&&n.setControls(r)},[n,a,c,t.controls,R,o,l]);const[P,K]=i.useState([]),[Q,J]=i.useState([]),de=i.useMemo(()=>({wiringNode:xt}),[]),X=i.useCallback(r=>{if(l)n.setControls({wiring_layout:JSON.stringify(r,null,2)});else try{localStorage.setItem(`${R}:layout`,JSON.stringify(r))}catch{}},[n,R,l]),V=i.useCallback(()=>{const r={version:1,nodes:{},hidden_modules:[]};if(l)return $;try{const x=localStorage.getItem(`${R}:layout`);if(!x)return r;const f=JSON.parse(x);return!f||typeof f!="object"||Array.isArray(f)?r:{version:typeof f.version=="number"?f.version:1,nodes:f.nodes&&typeof f.nodes=="object"?f.nodes:{},hidden_modules:Array.isArray(f.hidden_modules)?f.hidden_modules.map(String):[]}}catch{return r}},[$,R,l]),le=i.useMemo(()=>l?$:V(),[$,V,l]),re=i.useMemo(()=>new Set(le.hidden_modules||[]),[le.hidden_modules]),he=i.useCallback(r=>{a&&n.setControls({models:JSON.stringify(r,null,2)})},[n,a]);i.useEffect(()=>{if(!W)return;const r=`${W}@@${q??""}@@${E??""}`;if(r!==u.current){u.current=r;try{const x=JSON.parse(W),f=Je(x);j(null),K(z=>{var ye;const D=V(),{nodes:O,edges:U,needsLayout:Y}=mt(f,Array.isArray((ye=t.spec)==null?void 0:ye.modules)?t.spec.modules.map(String):[],N,new Set(D.hidden_modules||[]),z),G=O.map(ie=>{const ce=(D.nodes||{})[ie.id];return ce?{...ie,position:{x:ce.x,y:ce.y}}:ie});J(U);const oe=Y&&Object.keys(D.nodes||{}).length===0,te=oe?De(G,U):G;if(oe){const ie={};for(const ce of te)ie[ce.id]={x:ce.position.x,y:ce.position.y};X({...D,nodes:ie,hidden_modules:D.hidden_modules||[],version:1})}return te}),v||p(W)}catch(x){const f=x instanceof Error?x.message:String(x);j(f),p(W)}}},[E,N,V,v,t.spec,X,q,W]);const ne=i.useCallback(r=>{const x=_e(r),f=JSON.stringify(x,null,2);C.current=f,n.setControls({wiring:f}),p(f),j(null);try{localStorage.setItem(R,JSON.stringify({wiring:f,updatedAt:Date.now()}))}catch{}},[n,R]),ue=i.useCallback((r,x,f)=>{if(K(z=>z.map(D=>{if(D.id!==r)return D;const O=D.data,U=x==="input"?"inputs":"outputs",Y=O[U];if(Y.includes(f))return D;const G={...O,[U]:[...Y,f].sort()};return{...D,data:G}})),!!c)try{const z=E?JSON.parse(E):{},D=z&&typeof z=="object"&&!Array.isArray(z)?z:{},O=D[r],U=O&&typeof O=="object"&&!Array.isArray(O)?{...O}:{},Y=x==="input"?"inputs":"outputs",G=Array.isArray(U[Y])?U[Y].map(String):[];G.includes(f)||G.push(f),G.sort((oe,te)=>oe.localeCompare(te)),U[Y]=G,D[r]=U,n.setControls({module_ports:JSON.stringify(D,null,2)})}catch{}},[n,c,E]),Se=i.useCallback(r=>{K(x=>{const f=F.applyNodeChanges(r,x);if(r.some(D=>D.type==="position"||D.type==="dimensions")){const D={};for(const U of f)D[U.id]={x:U.position.x,y:U.position.y};const O=V();X({...O,nodes:{...O.nodes||{},...D},hidden_modules:O.hidden_modules||[],version:1})}return f})},[V,X]),we=i.useCallback(r=>{const x=r.some(f=>f.type==="remove"||f.type==="add");J(f=>{const z=F.applyEdgeChanges(r,f);return x&&ne(z),z})},[ne]),Ne=i.useCallback(()=>{if(!m)return;const r=m.sourcePort.trim(),x=m.targetPort.trim();if(r.includes(".")||x.includes(".")){j('Port names must not include "."');return}!r||!x||(ue(m.source,"output",r),ue(m.target,"input",x),J(f=>{const z=F.addEdge({id:`e-${Date.now()}`,source:m.source,sourceHandle:r,target:m.target,targetHandle:x,type:"smoothstep",style:{stroke:"#6b7280",strokeWidth:2}},f);return ne(z),z}),A(null))},[ue,m,ne]),Ce=i.useCallback(r=>{if(S||!r.source||!r.target)return;let x=r.sourceHandle,f=r.targetHandle;if(!(!x||!f)){if(x===pe){A({source:r.source,target:r.target,sourceHandle:x,targetHandle:f,sourcePort:"",targetPort:f===pe?"":String(f),mode:f===pe?"both":"from"});return}if(f===pe){A({source:r.source,target:r.target,sourceHandle:x,targetHandle:f,sourcePort:String(x),targetPort:"",mode:"to"});return}J(z=>{const D=F.addEdge({...r,sourceHandle:x,targetHandle:f,id:`e-${Date.now()}`,type:"smoothstep",style:{stroke:"#6b7280",strokeWidth:2}},z);return ne(D),D})}},[S,ue,ne]),ke=i.useCallback(()=>{try{const r=JSON.parse(h),x=JSON.stringify(_e(ht(r)),null,2);C.current=x,n.setControls({wiring:x}),j(null),b(!1);try{localStorage.setItem(R,JSON.stringify({wiring:x,updatedAt:Date.now()}))}catch{}}catch(r){const x=r instanceof Error?r.message:String(r);j(x),g(!0),b(!0)}},[n,h,R]),Me=i.useCallback(()=>{K(r=>{const x=De(r,Q),f={};for(const D of x)f[D.id]={x:D.position.x,y:D.position.y};const z=V();return X({...z,nodes:{...z.nodes||{},...f},hidden_modules:z.hidden_modules||[],version:1}),x})},[Q,V,X]),$e=i.useCallback(()=>{const r=V();X({...r,nodes:{},hidden_modules:r.hidden_modules||[],version:1}),K(x=>x.map(f=>({...f,position:{x:0,y:0}})))},[V,X]),fe=i.useMemo(()=>Q.filter(r=>!re.has(r.source)&&!re.has(r.target)),[Q,re]),Ae=P.length,Re=fe.length,ge=i.useMemo(()=>{var x;const r=new Set;for(const f of Array.isArray((x=t.spec)==null?void 0:x.modules)?t.spec.modules:[])r.add(String(f));for(const f of Object.keys(N||{}))r.add(String(f));for(const f of P)r.add(String(f.id));return Array.from(r).sort((f,z)=>f.localeCompare(z))},[P,N,t.spec]),ee=i.useCallback(r=>{const x=V(),f=new Set(x.hidden_modules||[]);f.has(r)?f.delete(r):f.add(r),X({...x,hidden_modules:Array.from(f).sort(),version:1,nodes:x.nodes||{}})},[V,X]),M=i.useCallback(r=>{if(!a)return;const x=I.current;if(!x)return;const f=V(),z=new Set(f.hidden_modules||[]);if(y.get(r)){const Y=Array.from(y.entries()).filter(([G])=>G!==r).map(([,G])=>G);he(Y),z.add(r),X({...f,hidden_modules:Array.from(z).sort(),nodes:f.nodes||{},version:1}),J(G=>{const oe=G.filter(te=>te.source!==r&&te.target!==r);return ne(oe),oe});return}const O=x.get(r);if(!O)return;const U=[...Array.from(y.values()),O];he(U),z.delete(r),X({...f,hidden_modules:Array.from(z).sort(),nodes:f.nodes||{},version:1})},[y,a,V,he,ne,X]);return o?e.jsxs("div",{className:`wiring-panel ${d?"expanded":"collapsed"}`,children:[e.jsxs("div",{className:"wiring-header",onClick:()=>g(r=>!r),children:[e.jsxs("div",{className:"wiring-title",children:[e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M9 18h6"}),e.jsx("path",{d:"M10 22h4"}),e.jsx("path",{d:"M12 2v10"}),e.jsx("path",{d:"M5 12h14"}),e.jsx("circle",{cx:"12",cy:"12",r:"3"})]}),e.jsx("span",{children:"Wiring"}),e.jsxs("span",{className:"wiring-meta",children:[Ae," modules · ",Re," connections"]}),re.size>0&&e.jsxs("span",{className:"wiring-meta",children:[re.size," hidden"]}),S&&e.jsx("span",{className:"wiring-locked",children:"locked while running"})]}),e.jsx("div",{className:"wiring-actions",children:e.jsx("button",{className:"expand-btn",onClick:r=>{r.stopPropagation(),g(x=>!x)},children:d?"Collapse":"Expand"})})]}),w&&e.jsxs("div",{className:"wiring-error",children:[e.jsxs("span",{children:["Invalid wiring JSON: ",w]}),e.jsx("button",{className:"btn btn-small btn-outline",onClick:()=>{g(!0),b(!0)},children:"Edit JSON"})]}),d&&e.jsxs("div",{className:"wiring-body",children:[e.jsx("div",{className:"wiring-canvas",children:e.jsxs(F.ReactFlow,{nodes:P,edges:fe,onNodesChange:Se,onEdgesChange:we,onConnect:Ce,nodeTypes:de,fitView:!0,snapToGrid:!0,snapGrid:[15,15],nodesDraggable:!S,nodesConnectable:!S,elementsSelectable:!S,deleteKeyCode:S?null:["Backspace","Delete"],style:{background:"var(--bg)"},children:[e.jsx(F.Background,{gap:20,size:1,color:"var(--border)"}),e.jsx(F.Controls,{style:{background:"var(--surface)",border:"1px solid var(--border)",borderRadius:6}})]})}),e.jsxs("div",{className:"wiring-advanced",children:[e.jsxs("div",{style:{display:"flex",gap:8,justifyContent:"space-between",flexWrap:"wrap"},children:[e.jsxs("div",{style:{display:"flex",gap:8},children:[e.jsx("button",{className:"btn btn-small btn-outline",onClick:Me,children:"Auto layout"}),e.jsx("button",{className:"btn btn-small btn-outline",onClick:$e,children:"Reset layout"})]}),e.jsx("button",{className:"btn btn-small btn-outline",onClick:()=>b(r=>!r),children:v?"Hide JSON":"Show JSON"})]}),ge.length>0&&e.jsxs("div",{className:"wiring-palette",children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:8},children:[e.jsx("div",{style:{fontSize:12,color:"var(--muted)",fontWeight:600},children:"Modules"}),e.jsx("div",{style:{fontSize:11,color:"var(--muted)"},children:"diagram only"})]}),e.jsx("div",{className:"wiring-palette-list",children:ge.map(r=>{const x=re.has(r);return e.jsxs("label",{className:"wiring-palette-item",children:[e.jsx("input",{type:"checkbox",checked:!x,onChange:()=>ee(r),disabled:S}),e.jsx("span",{style:{color:x?"var(--muted)":"var(--text)"},children:r})]},r)})})]}),T&&T.length>0&&e.jsxs("div",{className:"wiring-palette",children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:8},children:[e.jsx("div",{style:{fontSize:12,color:"var(--muted)",fontWeight:600},children:"Run Composition"}),e.jsx("div",{style:{fontSize:11,color:"var(--muted)"},children:"affects run"})]}),e.jsx("div",{className:"wiring-palette-list",children:T.map(r=>{const x=y.has(r);return e.jsxs("label",{className:"wiring-palette-item",children:[e.jsx("input",{type:"checkbox",checked:x,onChange:()=>M(r),disabled:S}),e.jsx("span",{style:{color:x?"var(--text)":"var(--muted)"},children:r})]},r)})})]}),v&&e.jsxs("div",{className:"wiring-json",children:[e.jsx("textarea",{className:"control-input",value:h,onChange:r=>p(r.target.value),rows:10,disabled:S}),e.jsxs("div",{className:"wiring-json-actions",children:[e.jsx("button",{className:"btn btn-small btn-primary",onClick:ke,disabled:S,children:"Apply"}),e.jsx("button",{className:"btn btn-small btn-outline",onClick:()=>{p(W??"[]"),j(null)},children:"Reset"})]})]})]})]}),m&&e.jsx("div",{className:"wiring-modal-backdrop",onClick:()=>A(null),role:"presentation",children:e.jsxs("div",{className:"wiring-modal",onClick:r=>r.stopPropagation(),children:[e.jsx("div",{className:"wiring-modal-title",children:"Add connection"}),e.jsxs("div",{className:"wiring-modal-subtitle",children:[m.source," → ",m.target]}),e.jsxs("div",{className:"wiring-modal-grid",children:[e.jsxs("label",{className:"wiring-modal-field",children:[e.jsx("span",{children:"From (output port)"}),e.jsx("input",{className:"control-input",value:m.sourcePort,onChange:r=>A(x=>x&&{...x,sourcePort:r.target.value}),placeholder:"e.g. population_state",disabled:S||m.mode==="to",list:`wiring-ports-out-${m.source}`})]}),e.jsxs("label",{className:"wiring-modal-field",children:[e.jsx("span",{children:"To (input port)"}),e.jsx("input",{className:"control-input",value:m.targetPort,onChange:r=>A(x=>x&&{...x,targetPort:r.target.value}),placeholder:"e.g. prey_state",disabled:S||m.mode==="from",list:`wiring-ports-in-${m.target}`})]})]}),e.jsx("datalist",{id:`wiring-ports-out-${m.source}`,children:(((H=P.find(r=>r.id===m.source))==null?void 0:H.data.outputs)??[]).map(r=>e.jsx("option",{value:String(r)},String(r)))}),e.jsx("datalist",{id:`wiring-ports-in-${m.target}`,children:(((Z=P.find(r=>r.id===m.target))==null?void 0:Z.data.inputs)??[]).map(r=>e.jsx("option",{value:String(r)},String(r)))}),e.jsxs("div",{className:"wiring-modal-actions",children:[e.jsx("button",{className:"btn btn-outline",onClick:()=>A(null),children:"Cancel"}),e.jsx("button",{className:"btn btn-primary",onClick:Ne,disabled:S,children:"Add"})]})]})})]}):null}function gt(s){const t=new Date(s);return Number.isNaN(t.getTime())?"":t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}function yt({adapter:s}){const[t,n]=i.useState([]),[o,l]=i.useState(!0),[c,a]=i.useState(null),[d,g]=i.useState(""),[w,j]=i.useState(!1),v=i.useRef(null);i.useEffect(()=>{let p=!0;return l(!0),s.getThread().then(m=>{p&&(n(m.messages??[]),a(null))}).catch(m=>{p&&a(m instanceof Error?m.message:String(m))}).finally(()=>{p&&l(!1)}),()=>{p=!1}},[s]),i.useEffect(()=>{var p;(p=v.current)==null||p.scrollIntoView({behavior:"smooth"})},[t.length]);const b=async()=>{const p=d.trim();if(!p||w)return;g(""),j(!0),a(null);const m=new Date().toISOString(),A={id:`local-user-${Date.now()}`,role:"user",content:p,createdAt:m},C=`local-assistant-${Date.now()}`,u={id:C,role:"assistant",content:"",createdAt:m};n(S=>[...S,A,u]);try{const S=await s.sendMessage({content:p,onChunk:R=>{R&&n(L=>L.map(W=>W.id===C?{...W,content:W.content+R}:W))}});n(R=>R.map(L=>L.id===C?S:L))}catch(S){const R=S instanceof Error?S.message:String(S);a(R),n(L=>L.filter(W=>W.id!==C))}finally{j(!1)}},h=p=>{p.key==="Enter"&&!p.shiftKey&&(p.preventDefault(),b())};return e.jsxs("div",{className:"chat-panel",children:[e.jsx("div",{className:"chat-header",children:e.jsxs("div",{children:[e.jsx("div",{className:"chat-title",children:"Simulation Chat"}),e.jsx("div",{className:"chat-subtitle",children:"Shared across related runs."})]})}),o&&e.jsx("div",{className:"chat-loading",children:"Loading chat history…"}),c&&e.jsx("div",{className:"chat-error",children:c}),e.jsxs("div",{className:`chat-messages ${t.length===0?"empty":""}`,children:[t.length===0&&!o&&e.jsx("div",{className:"chat-empty",children:"Start a conversation about this simulation."}),t.map(p=>e.jsxs("div",{className:`chat-message ${p.role==="user"?"user":"assistant"}`,children:[e.jsx("div",{className:"chat-bubble",children:p.content}),e.jsx("div",{className:"chat-meta",children:gt(p.createdAt)})]},p.id)),e.jsx("div",{ref:v})]}),e.jsxs("div",{className:"chat-input",children:[e.jsx("textarea",{className:"chat-textarea",placeholder:"Ask about parameters, outputs, or model behavior…",value:d,onChange:p=>g(p.target.value),onKeyDown:h,rows:2,disabled:w}),e.jsx("button",{type:"button",className:"btn btn-primary",onClick:b,disabled:w||!d.trim(),children:w?"Sending…":"Send"})]})]})}function Pe({message:s,description:t}){return e.jsx("div",{className:"empty-state",children:e.jsxs("div",{className:"empty-content",children:[e.jsx("h3",{children:s}),t&&e.jsx("p",{children:t})]})})}function bt({chatAdapter:s}){var v;const{state:t}=se(),n=ve(),o=i.useMemo(()=>t.visibleModules.size?n.filter(b=>t.visibleModules.has(b)):n,[n,t.visibleModules]),l=Ke(),c=(v=t.spec)==null?void 0:v.description,a=!!s,d=i.useMemo(()=>{var b,h;return!!((h=(b=t.spec)==null?void 0:b.controls)!=null&&h.some(p=>p.type==="json"&&p.name==="wiring"))},[t.spec]),[g,w]=i.useState("visuals"),j=n.length===0?e.jsxs(e.Fragment,{children:[c&&e.jsx(Te,{description:c}),e.jsx(Pe,{message:"No modules found",description:"The simulation doesn't have any modules to display yet."})]}):o.length===0?e.jsxs(e.Fragment,{children:[c&&e.jsx(Te,{description:c}),e.jsx(Pe,{message:"No modules selected",description:"Select modules from the sidebar to view their visualizations."})]}):e.jsxs(e.Fragment,{children:[c&&e.jsx(Te,{description:c}),e.jsx("div",{className:"modules-grid",children:o.map(b=>e.jsx(pt,{moduleName:b,visuals:l.get(b)||[]},b))})]});return e.jsxs("div",{className:"main-content",children:[e.jsxs("div",{className:"main-tabs",children:[e.jsx("button",{type:"button",className:`main-tab ${g==="visuals"?"active":""}`,onClick:()=>w("visuals"),children:"Visualizations"}),d&&e.jsx("button",{type:"button",className:`main-tab ${g==="wiring"?"active":""}`,onClick:()=>w("wiring"),children:"Wiring"}),a&&e.jsx("button",{type:"button",className:`main-tab ${g==="chat"?"active":""}`,onClick:()=>w("chat"),children:"Chat"})]}),g==="chat"&&s&&e.jsx(yt,{adapter:s}),g==="wiring"&&d&&e.jsx(ft,{}),g==="visuals"&&j]})}function jt(){var E,k;const s=xe(),{state:t,actions:n}=se(),o=t.events||[],l=((E=t.status)==null?void 0:E.running)??!1,[c,a]=i.useState("events"),[d,g]=i.useState([]),[w,j]=i.useState(!1),v=i.useRef(0),b=i.useRef(null),h=i.useRef(null),[p,m]=i.useState(!0),[A,C]=i.useState(!0);i.useEffect(()=>{p&&b.current&&(b.current.scrollTop=b.current.scrollHeight)},[o,p]),i.useEffect(()=>{A&&h.current&&(h.current.scrollTop=h.current.scrollHeight)},[d,A]);const u=i.useCallback(()=>{if(!b.current)return;const{scrollTop:N,scrollHeight:I,clientHeight:y}=b.current;m(N+y>=I-10)},[]),S=i.useCallback(()=>{if(!h.current)return;const{scrollTop:N,scrollHeight:I,clientHeight:y}=h.current;C(N+y>=I-10)},[]);i.useEffect(()=>{if(c!=="logs"||!s.logs)return;let N=!1;const I=async()=>{if(!N){j(!0);try{const T=v.current>0?v.current:void 0,$=await s.logs(T);if(N)return;$.items&&$.items.length>0&&g(P=>{var X;const K=new Set(P.map(V=>V.id)),Q=$.items.filter(V=>!K.has(V.id));if(Q.length===0)return P;const J=[...P,...Q].sort((V,le)=>V.seq-le.seq),de=((X=J[J.length-1])==null?void 0:X.seq)??0;return de>v.current&&(v.current=de),J})}catch(T){console.error("Failed to fetch run logs:",T)}finally{N||j(!1)}}};I();const y=setInterval(I,3e3);return()=>{N=!0,clearInterval(y)}},[c,s,l]);const R=!!s.logs,L=R?c:"events",W=N=>N==="error"?"log-level log-level--error":N==="warning"?"log-level log-level--warning":"log-level log-level--info",q=N=>N==="sandbox"?"SANDBOX":N==="system"?"SYSTEM":N==="runstream"?"STREAM":N.toUpperCase();return e.jsx("div",{className:"footer",children:e.jsxs("div",{className:"footer-content",children:[e.jsxs("header",{className:"footer-header",children:[e.jsx("div",{className:"footer-title-section",children:R?e.jsxs("div",{className:"footer-tabs",children:[e.jsxs("button",{className:`footer-tab ${L==="events"?"footer-tab--active":""}`,onClick:()=>a("events"),children:["Events",o.length>0&&e.jsx("span",{className:"footer-tab-badge",children:o.length})]}),e.jsxs("button",{className:`footer-tab ${L==="logs"?"footer-tab--active":""}`,onClick:()=>a("logs"),children:["Logs",d.length>0&&e.jsx("span",{className:"footer-tab-badge",children:d.length})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("h2",{className:"footer-title",children:"Event Log"}),e.jsx("div",{className:"event-stats",children:e.jsxs("div",{className:"stat-item",children:[e.jsx("span",{className:"stat-label",children:"Total:"}),e.jsx("span",{className:"stat-value",children:o.length})]})})]})}),e.jsxs("div",{className:"footer-actions",children:[L==="events"&&o.length>0&&e.jsx("button",{className:"btn btn-small btn-outline",onClick:()=>n.setEvents([]),children:"Clear"}),L==="logs"&&d.length>0&&e.jsx("button",{className:"btn btn-small btn-outline",onClick:()=>{g([]),v.current=0},children:"Clear"})]})]}),e.jsxs("div",{className:"footer-body",children:[L==="events"&&e.jsx(e.Fragment,{children:o.length===0?e.jsx("div",{className:"event-list empty",children:e.jsxs("div",{className:"empty-state",children:[e.jsx("p",{children:"No events recorded yet"}),((k=t.status)==null?void 0:k.phase_message)&&e.jsx("p",{className:"empty-state-phase",children:t.status.phase_message})]})}):e.jsxs("div",{className:"event-list-container",children:[e.jsxs("div",{className:"event-list-header",children:[e.jsxs("span",{className:"event-count",children:[o.length," event",o.length!==1?"s":""]}),e.jsx("div",{className:"event-controls",children:e.jsx("button",{className:`btn btn-small ${p?"active":""}`,onClick:()=>m(!p),title:p?"Auto-scroll enabled":"Auto-scroll disabled",children:"📌"})})]}),e.jsx("div",{ref:b,className:"event-list",onScroll:u,children:o.slice().reverse().map(N=>{var I;return e.jsxs("div",{className:`event-item ${N.event==="phase"?"event-item--phase":""}`,children:[e.jsx("time",{className:"event-timestamp",dateTime:N.ts,children:N.ts}),e.jsx("div",{className:"event-message",children:N.event==="phase"&&((I=N.payload)!=null&&I.message)?String(N.payload.message):N.event})]},N.id)})})]})}),L==="logs"&&e.jsx(e.Fragment,{children:d.length===0?e.jsx("div",{className:"event-list empty",children:e.jsx("div",{className:"empty-state",children:e.jsx("p",{children:w?"Loading logs...":"No logs available yet"})})}):e.jsxs("div",{className:"event-list-container",children:[e.jsxs("div",{className:"event-list-header",children:[e.jsxs("span",{className:"event-count",children:[d.length," log entr",d.length!==1?"ies":"y"]}),e.jsx("div",{className:"event-controls",children:e.jsx("button",{className:`btn btn-small ${A?"active":""}`,onClick:()=>C(!A),title:A?"Auto-scroll enabled":"Auto-scroll disabled",children:"📌"})})]}),e.jsx("div",{ref:h,className:"event-list",onScroll:S,children:d.map(N=>e.jsxs("div",{className:`event-item log-item log-item--${N.level}`,children:[e.jsxs("div",{className:"log-item-header",children:[e.jsx("time",{className:"event-timestamp",dateTime:N.ts,children:N.ts}),e.jsx("span",{className:`log-source log-source--${N.source}`,children:q(N.source)}),e.jsx("span",{className:W(N.level),children:N.level.toUpperCase()})]}),N.message&&e.jsx("div",{className:"event-message",children:N.message})]},N.id))})]})})]})]})})}const vt=({data:s,selected:t})=>{const n=s,{label:o,moduleType:l,inputs:c,outputs:a}=n,d=l.split(".").pop()||l,g=l.includes(".neuro.")?"neuro":l.includes(".ecology.")?"ecology":"custom",j={neuro:{bg:"var(--primary-bg)",border:"var(--primary)",header:"var(--primary-dark)",text:"var(--primary-text)"},ecology:{bg:"#14352a",border:"#22c55e",header:"#16a34a",text:"#dcfce7"},custom:{bg:"#2e1a47",border:"#a855f7",header:"#9333ea",text:"#f3e8ff"}}[g];return e.jsxs("div",{className:"module-node",style:{background:j.bg,border:`2px solid ${t?"#fbbf24":j.border}`,borderRadius:"10px",minWidth:"180px",boxShadow:t?"0 0 0 2px #fbbf24":"0 4px 16px rgba(0,0,0,0.5)",fontFamily:"ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, sans-serif"},children:[e.jsx("div",{style:{background:j.header,color:"#fff",padding:"10px 14px",borderRadius:"8px 8px 0 0",fontWeight:600,fontSize:"14px",letterSpacing:"0.01em"},children:o}),e.jsx("div",{style:{padding:"6px 14px",fontSize:"12px",color:j.text,borderBottom:`1px solid ${j.border}50`,opacity:.85},children:d}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",padding:"10px 0"},children:[e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"6px"},children:[c.map(v=>e.jsxs("div",{style:{position:"relative",paddingLeft:"14px"},children:[e.jsx(F.Handle,{type:"target",position:F.Position.Left,id:v,style:{width:"12px",height:"12px",background:"#6b7280",border:"2px solid var(--primary-bg)",left:"-6px"}}),e.jsx("span",{style:{fontSize:"12px",color:j.text,fontWeight:500},children:v})]},v)),c.length===0&&e.jsx("div",{style:{paddingLeft:"14px",fontSize:"12px",color:"#9aa6c1",fontStyle:"italic"},children:"no inputs"})]}),e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"6px",alignItems:"flex-end"},children:[a.map(v=>e.jsxs("div",{style:{position:"relative",paddingRight:"14px"},children:[e.jsx("span",{style:{fontSize:"12px",color:j.text,fontWeight:500},children:v}),e.jsx(F.Handle,{type:"source",position:F.Position.Right,id:v,style:{width:"12px",height:"12px",background:j.header,border:"2px solid var(--primary-bg)",right:"-6px"}})]},v)),a.length===0&&e.jsx("div",{style:{paddingRight:"14px",fontSize:"12px",color:"#9aa6c1",fontStyle:"italic"},children:"no outputs"})]})]})]})},St=i.memo(vt),wt=({registry:s,onDragStart:t})=>{const[n,o]=i.useState(new Set(["neuro","ecology"])),[l,c]=i.useState(""),a="#0f1628",d="#11182b",g="#e6eaf2",w="#9aa6c1",j="#1e2a44";if(!s)return e.jsx("div",{className:"module-palette",style:{padding:"16px",background:d,color:w},children:e.jsx("div",{children:"Loading modules..."})});const v=p=>{const m=new Set(n);m.has(p)?m.delete(p):m.add(p),o(m)},b={neuro:"var(--primary)",ecology:"#22c55e",custom:"#a855f7"},h=Object.entries(s.categories).map(([p,m])=>{const A=m.map(C=>({path:C,spec:s.modules[C]})).filter(({spec:C})=>{var S;if(!C)return!1;if(!l)return!0;const u=l.toLowerCase();return C.name.toLowerCase().includes(u)||((S=C.description)==null?void 0:S.toLowerCase().includes(u))||p.toLowerCase().includes(u)});return{category:p,modules:A}}).filter(({modules:p})=>p.length>0);return e.jsxs("div",{className:"module-palette",style:{height:"100%",display:"flex",flexDirection:"column",background:d,fontFamily:"ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, sans-serif"},children:[e.jsxs("div",{style:{padding:"14px",borderBottom:`1px solid ${j}`},children:[e.jsx("h3",{style:{margin:"0 0 10px 0",fontSize:"14px",fontWeight:600,color:g},children:"Modules"}),e.jsx("input",{type:"text",placeholder:"Search modules...",value:l,onChange:p=>c(p.target.value),style:{width:"100%",padding:"8px 12px",border:`1px solid ${j}`,borderRadius:"8px",fontSize:"13px",background:a,color:g}})]}),e.jsxs("div",{style:{flex:1,overflow:"auto",padding:"8px"},children:[h.map(({category:p,modules:m})=>e.jsxs("div",{style:{marginBottom:"8px"},children:[e.jsxs("button",{onClick:()=>v(p),style:{width:"100%",display:"flex",alignItems:"center",gap:"8px",padding:"10px",background:"none",border:"none",cursor:"pointer",fontSize:"13px",fontWeight:600,color:g,textAlign:"left"},children:[e.jsx("span",{style:{transform:n.has(p)?"rotate(90deg)":"rotate(0deg)",transition:"transform 0.2s",color:w},children:"▶"}),e.jsx("span",{style:{width:"10px",height:"10px",borderRadius:"50%",background:b[p]||"#666"}}),p.charAt(0).toUpperCase()+p.slice(1),e.jsx("span",{style:{marginLeft:"auto",fontSize:"12px",color:w},children:m.length})]}),n.has(p)&&e.jsx("div",{style:{paddingLeft:"16px"},children:m.map(({path:A,spec:C})=>e.jsxs("div",{draggable:!0,onDragStart:u=>t(u,A,C),style:{padding:"10px 12px",marginBottom:"6px",background:a,border:`1px solid ${j}`,borderRadius:"8px",cursor:"grab",fontSize:"13px"},title:C.description||A,children:[e.jsx("div",{style:{fontWeight:500,color:g},children:C.name}),e.jsxs("div",{style:{fontSize:"11px",color:w,marginTop:"4px"},children:[C.inputs.length>0&&e.jsxs("span",{children:["in: ",C.inputs.join(", ")]}),C.inputs.length>0&&C.outputs.length>0&&" | ",C.outputs.length>0&&e.jsxs("span",{children:["out: ",C.outputs.join(", ")]})]})]},A))})]},p)),h.length===0&&e.jsx("div",{style:{padding:"16px",textAlign:"center",color:w,fontSize:"13px"},children:"No modules found"})]}),e.jsx("div",{style:{padding:"10px 14px",borderTop:`1px solid ${j}`,fontSize:"12px",color:w},children:"Drag modules to canvas"})]})},Nt=({selectedNode:s,registry:t,onUpdateNode:n,onDeleteNode:o,onRenameNode:l})=>{const c="#0f1628",a="#11182b",d="#e6eaf2",g="#9aa6c1",w="#1e2a44",j="#22d3ee";if(!s)return e.jsxs("div",{className:"properties-panel",style:{padding:"16px",background:a,color:g,fontFamily:"ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, sans-serif"},children:[e.jsx("h3",{style:{margin:"0 0 10px 0",fontSize:"14px",fontWeight:600,color:d},children:"Properties"}),e.jsx("p",{style:{fontSize:"13px",color:g},children:"Select a node to edit its properties"})]});const v=s.data,b=t==null?void 0:t.modules[v.moduleType],h=(u,S)=>{const R={...v.args,[u]:S};n(s.id,R)},p=u=>{const S=u.target.value.trim();S&&S!==s.id&&l(s.id,S)},m=(u,S)=>{if(S==="int"||S==="float"||S==="number"){const R=parseFloat(u);return isNaN(R)?0:R}if(S==="bool"||S==="boolean")return u==="true"||u==="1";if(S==="list"||S==="List")try{return JSON.parse(u)}catch{return[]}return u},A=u=>u==null?"":typeof u=="object"?JSON.stringify(u):String(u),C={width:"100%",padding:"8px 12px",border:`1px solid ${w}`,borderRadius:"8px",fontSize:"13px",background:c,color:d};return e.jsxs("div",{className:"properties-panel",style:{height:"100%",display:"flex",flexDirection:"column",background:a,fontFamily:"ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, sans-serif"},children:[e.jsx("div",{style:{padding:"14px",borderBottom:`1px solid ${w}`},children:e.jsx("h3",{style:{margin:"0",fontSize:"14px",fontWeight:600,color:d},children:"Properties"})}),e.jsxs("div",{style:{flex:1,overflow:"auto",padding:"14px"},children:[e.jsxs("div",{style:{marginBottom:"18px"},children:[e.jsx("label",{style:{display:"block",fontSize:"12px",fontWeight:500,marginBottom:"6px",color:d},children:"Node ID"}),e.jsx("input",{type:"text",defaultValue:s.id,onBlur:p,onKeyDown:u=>{u.key==="Enter"&&u.currentTarget.blur()},style:C})]}),e.jsxs("div",{style:{marginBottom:"18px"},children:[e.jsx("label",{style:{display:"block",fontSize:"12px",fontWeight:500,marginBottom:"6px",color:d},children:"Module Type"}),e.jsx("div",{style:{padding:"8px 12px",background:c,borderRadius:"8px",fontSize:"12px",color:g,border:`1px solid ${w}`},children:v.moduleType})]}),(b==null?void 0:b.description)&&e.jsx("div",{style:{marginBottom:"18px",padding:"10px",background:"#0c2135",borderRadius:"8px",fontSize:"12px",color:j,border:`1px solid ${w}`},children:b.description.split(`
`)[0]}),e.jsxs("div",{style:{marginBottom:"10px"},children:[e.jsx("label",{style:{display:"block",fontSize:"12px",fontWeight:600,marginBottom:"10px",color:d},children:"Arguments"}),b==null?void 0:b.args.map(u=>{const S=v.args[u.name]??u.default,R=u.type==="bool"||u.type==="boolean"?"checkbox":"text";return e.jsxs("div",{style:{marginBottom:"14px"},children:[e.jsxs("label",{style:{display:"flex",alignItems:"center",gap:"6px",fontSize:"12px",marginBottom:"6px",color:g},children:[e.jsx("span",{style:{fontWeight:500,color:d},children:u.name}),e.jsxs("span",{style:{color:g},children:["(",u.type,")"]}),u.required&&e.jsx("span",{style:{color:"#ef4444"},children:"*"})]}),R==="checkbox"?e.jsx("input",{type:"checkbox",checked:!!S,onChange:L=>h(u.name,L.target.checked),style:{width:"18px",height:"18px",accentColor:j}}):u.options?e.jsx("select",{value:String(S),onChange:L=>h(u.name,m(L.target.value,u.type)),style:C,children:u.options.map(L=>e.jsx("option",{value:String(L),children:String(L)},String(L)))}):e.jsx("input",{type:"text",value:A(S),onChange:L=>h(u.name,m(L.target.value,u.type)),placeholder:u.default!==null?`Default: ${A(u.default)}`:"",style:C}),u.description&&e.jsx("div",{style:{fontSize:"11px",color:g,marginTop:"4px"},children:u.description})]},u.name)}),(!b||b.args.length===0)&&e.jsx("div",{style:{fontSize:"13px",color:g,fontStyle:"italic"},children:"No configurable arguments"})]}),e.jsxs("div",{style:{marginTop:"18px",paddingTop:"18px",borderTop:`1px solid ${w}`},children:[e.jsx("label",{style:{display:"block",fontSize:"12px",fontWeight:600,marginBottom:"10px",color:d},children:"Ports"}),e.jsxs("div",{style:{display:"flex",gap:"20px"},children:[e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:"12px",color:g,marginBottom:"6px"},children:"Inputs"}),v.inputs.length>0?v.inputs.map(u=>e.jsx("div",{style:{fontSize:"12px",color:d},children:u},u)):e.jsx("div",{style:{fontSize:"12px",color:g,fontStyle:"italic"},children:"none"})]}),e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:"12px",color:g,marginBottom:"6px"},children:"Outputs"}),v.outputs.length>0?v.outputs.map(u=>e.jsx("div",{style:{fontSize:"12px",color:d},children:u},u)):e.jsx("div",{style:{fontSize:"12px",color:g,fontStyle:"italic"},children:"none"})]})]})]})]}),e.jsx("div",{style:{padding:"14px",borderTop:`1px solid ${w}`},children:e.jsx("button",{onClick:()=>o(s.id),style:{width:"100%",padding:"10px",background:"#3b1c1c",border:"1px solid #7f1d1d",borderRadius:"8px",color:"#fca5a5",fontSize:"13px",fontWeight:500,cursor:"pointer"},children:"Delete Node"})})]})},Le=(s,t,n="LR")=>{const o=new be.graphlib.Graph;o.setDefaultEdgeLabel(()=>({}));const l=200,c=120;return o.setGraph({rankdir:n,nodesep:50,ranksep:100}),s.forEach(d=>{o.setNode(d.id,{width:l,height:c})}),t.forEach(d=>{o.setEdge(d.source,d.target)}),be.layout(o),{nodes:s.map(d=>{const g=o.node(d.id);return{...d,position:{x:g.x-l/2,y:g.y-c/2}}}),edges:t}},We=(s,t)=>{const n=s.nodes.map(l=>{const c=t==null?void 0:t.modules[l.type];return{id:l.id,type:"moduleNode",position:l.position,data:{label:l.id,moduleType:l.type,args:l.data.args,inputs:l.data.inputs.length>0?l.data.inputs:(c==null?void 0:c.inputs)||[],outputs:l.data.outputs.length>0?l.data.outputs:(c==null?void 0:c.outputs)||[]}}}),o=s.edges.map(l=>({id:l.id,source:l.source,sourceHandle:l.sourceHandle,target:l.target,targetHandle:l.targetHandle,type:"smoothstep",animated:!1,style:{stroke:"var(--primary-muted)",strokeWidth:2}}));return{nodes:n,edges:o}},ze=(s,t,n)=>{const o=s.map(c=>{const a=c.data;return{id:c.id,type:a.moduleType,position:c.position,data:{args:a.args,inputs:a.inputs,outputs:a.outputs}}}),l=t.map(c=>({id:c.id,source:c.source,sourceHandle:c.sourceHandle||"",target:c.target,targetHandle:c.targetHandle||""}));return{nodes:o,edges:l,meta:n}},Ct=({api:s,initialConfigPath:t})=>{const n=s.editor,[o,l,c]=F.useNodesState([]),[a,d,g]=F.useEdgesState([]),[w,j]=i.useState(null),[v,b]=i.useState(null),[h,p]=i.useState(t||""),[m,A]=i.useState({}),[C,u]=i.useState(!1),[S,R]=i.useState(null),[L,W]=i.useState([]),[q,E]=i.useState(!t),[k,N]=i.useState(!1),[I,y]=i.useState(""),T=i.useRef(null),$="#0f1628",P="#11182b",K="#e6eaf2",Q="#9aa6c1",J="#1e2a44",de="var(--primary)",X=i.useMemo(()=>({moduleNode:St}),[]),[V,le]=i.useState(!1);i.useEffect(()=>{(async()=>{try{const[B,_]=await Promise.all([n.getModules(),n.getCurrent()]);if(j(B),_.available&&_.graph){const{nodes:H,edges:Z}=We(_.graph,B);if(H.every(x=>x.position.x===0&&x.position.y===0)&&H.length>0){const x=Le(H,Z);l(x.nodes),d(x.edges)}else l(H),d(Z);A(_.graph.meta),p(_.path||""),u(!1),E(!1)}else{const H=await n.listFiles();W(H),E(!0)}}catch(B){console.error("Failed to initialize editor:",B),n.listFiles().then(W).catch(console.error)}})()},[s,l,d]);const re=i.useCallback(async M=>{try{R(null);const B=await n.getConfig(M),{nodes:_,edges:H}=We(B,w);if(_.every(r=>r.position.x===0&&r.position.y===0)&&_.length>0){const r=Le(_,H);l(r.nodes),d(r.edges)}else l(_),d(H);A(B.meta),p(M),u(!1),E(!1)}catch(B){R(`Failed to load config: ${B}`)}},[s,w,l,d]),he=i.useCallback(async()=>{if(!h){R("No config path specified");return}try{const M=ze(o,a,m);await n.saveConfig(h,M),u(!1),R(null)}catch(M){R(`Failed to save: ${M}`)}},[s,h,o,a,m]),ne=i.useCallback(async()=>{if(!h){R("No config path specified");return}le(!0);try{const M=ze(o,a,m),B=await n.applyConfig(M,h);B.ok?(u(!1),R(null),R("Configuration applied successfully!"),setTimeout(()=>R(null),3e3)):R(`Failed to apply: ${B.error||"Unknown error"}`)}catch(M){R(`Failed to apply config: ${M}`)}finally{le(!1)}},[s,h,o,a,m]),ue=i.useCallback(()=>{const M=Le(o,a);l(M.nodes),d(M.edges),u(!0)},[o,a,l,d]),Se=i.useCallback(M=>{const B={...M,id:`e${Date.now()}`,type:"smoothstep",style:{stroke:"var(--primary-muted)",strokeWidth:2}};d(_=>F.addEdge(B,_)),u(!0)},[d]),we=i.useCallback(({nodes:M})=>{b(M.length===1?M[0]:null)},[]),Ne=i.useCallback(()=>{u(!0)},[]),Ce=i.useCallback(M=>{M.preventDefault(),M.dataTransfer.dropEffect="move"},[]),ke=i.useCallback(M=>{M.preventDefault();const B=M.dataTransfer.getData("application/moduleType"),_=M.dataTransfer.getData("application/moduleSpec");if(!B||!_)return;const H=JSON.parse(_),Z=T.current;if(!Z)return;const r=Z.getBoundingClientRect(),x={x:M.clientX-r.left-100,y:M.clientY-r.top-50};let f=H.name.toLowerCase().replace(/[^a-z0-9]/g,"_"),z=1,D=f;for(;o.some(U=>U.id===D);)D=`${f}_${z++}`;const O={id:D,type:"moduleNode",position:x,data:{label:D,moduleType:B,args:{},inputs:H.inputs,outputs:H.outputs}};l(U=>[...U,O]),u(!0)},[o,l]),Me=i.useCallback((M,B,_)=>{M.dataTransfer.setData("application/moduleType",B),M.dataTransfer.setData("application/moduleSpec",JSON.stringify(_)),M.dataTransfer.effectAllowed="move"},[]),$e=i.useCallback((M,B)=>{l(_=>_.map(H=>H.id===M?{...H,data:{...H.data,args:B}}:H)),u(!0)},[l]),fe=i.useCallback(M=>{l(B=>B.filter(_=>_.id!==M)),d(B=>B.filter(_=>_.source!==M&&_.target!==M)),b(null),u(!0)},[l,d]),Ae=i.useCallback((M,B)=>{if(o.some(_=>_.id===B&&_.id!==M)){R(`Node ID "${B}" already exists`);return}l(_=>_.map(H=>H.id===M?{...H,id:B,data:{...H.data,label:B}}:H)),d(_=>_.map(H=>{const Z={...H};return H.source===M&&(Z.source=B),H.target===M&&(Z.target=B),Z})),b(_=>(_==null?void 0:_.id)===M?{..._,id:B}:_),u(!0)},[o,l,d]),Re=i.useCallback(()=>{l([]),d([]),A({title:"New Configuration"}),p(""),u(!0),E(!1)},[l,d]),ge=i.useCallback(async()=>{try{const M=ze(o,a,m),B=await n.toYaml(M);y(B.yaml),N(!0)}catch(M){R(`Failed to generate YAML: ${M}`)}},[s,o,a,m]),ee={padding:"6px 12px",border:`1px solid ${J}`,borderRadius:"6px",background:P,color:K,cursor:"pointer",fontSize:"13px",fontWeight:500};return e.jsxs("div",{style:{display:"flex",height:"100vh",width:"100%",background:$},children:[e.jsx("div",{style:{width:"240px",borderRight:`1px solid ${J}`,background:P},children:e.jsx(wt,{registry:w,onDragStart:Me})}),e.jsxs("div",{style:{flex:1,display:"flex",flexDirection:"column"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px",padding:"8px 12px",borderBottom:`1px solid ${J}`,background:P},children:[e.jsx("button",{onClick:()=>E(!0),style:ee,children:"Open"}),e.jsx("button",{onClick:Re,style:ee,children:"New"}),e.jsx("button",{onClick:he,disabled:!C||!h,style:{...ee,background:C&&h?de:J,color:C&&h?"#fff":Q,cursor:C&&h?"pointer":"not-allowed"},children:"Save"}),e.jsx("button",{onClick:ne,disabled:V||!h,style:{...ee,background:h&&!V?"#22c55e":J,color:h&&!V?"#fff":Q,cursor:h&&!V?"pointer":"not-allowed"},children:V?"Applying...":"Apply to Simulation"}),e.jsx("div",{style:{width:"1px",height:"20px",background:J}}),e.jsx("button",{onClick:ue,style:ee,children:"Auto Layout"}),e.jsx("button",{onClick:ge,style:ee,children:"View YAML"}),e.jsx("div",{style:{flex:1}}),h&&e.jsxs("span",{style:{fontSize:"12px",color:Q},children:[h,C&&e.jsx("span",{style:{color:"#f59e0b"},children:" (unsaved)"})]})]}),S&&e.jsxs("div",{style:{padding:"8px 12px",background:S.includes("success")?"#14352a":"#3b1c1c",borderBottom:`1px solid ${S.includes("success")?"#22c55e":"#7f1d1d"}`,color:S.includes("success")?"#86efac":"#fca5a5",fontSize:"13px"},children:[S,e.jsx("button",{onClick:()=>R(null),style:{marginLeft:"8px",background:"none",border:"none",cursor:"pointer",color:S.includes("success")?"#86efac":"#fca5a5"},children:"✕"})]}),e.jsx("div",{ref:T,style:{flex:1,background:$},onDragOver:Ce,onDrop:ke,children:e.jsxs(F.ReactFlow,{nodes:o,edges:a,onNodesChange:c,onEdgesChange:g,onConnect:Se,onSelectionChange:we,onNodeDragStop:Ne,nodeTypes:X,fitView:!0,snapToGrid:!0,snapGrid:[15,15],deleteKeyCode:["Backspace","Delete"],onNodesDelete:()=>u(!0),onEdgesDelete:()=>u(!0),style:{background:$},children:[e.jsx(F.Background,{variant:F.BackgroundVariant.Dots,gap:20,size:1,color:J}),e.jsx(F.Controls,{style:{background:P,border:`1px solid ${J}`,borderRadius:"6px"}}),e.jsx(F.MiniMap,{nodeColor:M=>{const B=M.data;return B.moduleType.includes(".neuro.")?"var(--primary)":B.moduleType.includes(".ecology.")?"#22c55e":"#a855f7"},maskColor:"rgba(11, 16, 32, 0.7)",style:{background:P,border:`1px solid ${J}`,borderRadius:"6px"}}),m.title&&e.jsx(F.Panel,{position:"top-center",children:e.jsx("div",{style:{padding:"6px 14px",background:P,borderRadius:"6px",border:`1px solid ${J}`,fontSize:"14px",fontWeight:600,color:K},children:m.title})})]})})]}),e.jsx("div",{style:{width:"280px",borderLeft:`1px solid ${J}`,background:P},children:e.jsx(Nt,{selectedNode:v,registry:w,onUpdateNode:$e,onDeleteNode:fe,onRenameNode:Ae})}),q&&e.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(0,0,0,0.7)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e3},onClick:()=>E(!1),children:e.jsxs("div",{style:{background:P,borderRadius:"10px",border:`1px solid ${J}`,width:"400px",maxHeight:"500px",overflow:"hidden",display:"flex",flexDirection:"column",boxShadow:"0 8px 32px rgba(0,0,0,0.4)"},onClick:M=>M.stopPropagation(),children:[e.jsx("div",{style:{padding:"16px",borderBottom:`1px solid ${J}`},children:e.jsx("h3",{style:{margin:0,fontSize:"16px",color:K,fontWeight:600},children:"Open Configuration"})}),e.jsxs("div",{style:{flex:1,overflow:"auto",padding:"8px"},children:[L.map(M=>e.jsxs("div",{onClick:()=>{M.is_dir?n.listFiles(M.path).then(W):re(M.path)},style:{padding:"10px 12px",cursor:"pointer",borderRadius:"6px",display:"flex",alignItems:"center",gap:"8px",color:K,fontSize:"13px"},onMouseOver:B=>B.currentTarget.style.background=$,onMouseOut:B=>B.currentTarget.style.background="transparent",children:[e.jsx("span",{children:M.is_dir?"📁":"📄"}),e.jsx("span",{children:M.name})]},M.path)),L.length===0&&e.jsx("div",{style:{padding:"16px",textAlign:"center",color:Q,fontSize:"13px"},children:"No config files found"})]}),e.jsx("div",{style:{padding:"12px",borderTop:`1px solid ${J}`,display:"flex",justifyContent:"flex-end"},children:e.jsx("button",{onClick:()=>E(!1),style:ee,children:"Cancel"})})]})}),k&&e.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(0,0,0,0.7)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e3},onClick:()=>N(!1),children:e.jsxs("div",{style:{background:P,borderRadius:"10px",border:`1px solid ${J}`,width:"600px",maxHeight:"80vh",overflow:"hidden",display:"flex",flexDirection:"column",boxShadow:"0 8px 32px rgba(0,0,0,0.4)"},onClick:M=>M.stopPropagation(),children:[e.jsxs("div",{style:{padding:"16px",borderBottom:`1px solid ${J}`,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx("h3",{style:{margin:0,fontSize:"16px",color:K,fontWeight:600},children:"YAML Preview"}),e.jsx("button",{onClick:()=>{navigator.clipboard.writeText(I)},style:{...ee,padding:"4px 12px",fontSize:"12px"},children:"Copy"})]}),e.jsx("pre",{style:{flex:1,overflow:"auto",padding:"16px",margin:0,background:$,color:K,fontSize:"12px",fontFamily:"ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace",lineHeight:1.5},children:I}),e.jsx("div",{style:{padding:"12px",borderTop:`1px solid ${J}`,display:"flex",justifyContent:"flex-end"},children:e.jsx("button",{onClick:()=>N(!1),style:ee,children:"Close"})})]})})]})};function kt({headerLeft:s,headerRight:t,chatAdapter:n}){var q;const o=xe(),{state:l,actions:c}=se(),[a,d]=i.useState(!1),[g,w]=i.useState(!1),[j,v]=i.useState(!1),b=i.useRef(null),h=i.useRef(null),p=E=>{if(typeof window>"u")return null;try{const k=window.sessionStorage.getItem(E);if(!k)return null;const N=JSON.parse(k);return!N||typeof N!="object"?null:N}catch{return null}},m=(E,k)=>{if(!(typeof window>"u"))try{window.sessionStorage.setItem(E,JSON.stringify(k))}catch{}},A=async()=>{try{const E=await o.state(),k=E==null?void 0:E.target,N=E==null?void 0:E.run,I=(k==null?void 0:k.modelId)??(N==null?void 0:N.model_id)??(N==null?void 0:N.modelId),y=(k==null?void 0:k.spaceId)??(N==null?void 0:N.project_id)??(N==null?void 0:N.spaceId);if(I)return`simui-controls:model:${I}`;if(y)return`simui-controls:space:${y}`}catch{}return"simui-controls:generic"},C=i.useCallback(async()=>{const E=await o.spec();c.setSpec(E);const k={},N=new Set;for(const $ of E.controls||[])me($)&&(N.add($.name),k[$.name]=$.default),ae($)&&(N.add($.name),k[$.name]=String($.default??""));const I=await A();h.current=I;const y=p(I),T={};if(y)for(const[$,P]of Object.entries(y))N.has($)&&(T[$]=P);c.setControls({...k,...T})},[o,c]),u=i.useCallback(E=>{switch(E.type){case"snapshot":{const k=E.data;k!=null&&k.status&&c.setStatus(k.status),Array.isArray(k==null?void 0:k.visuals)&&c.setVisuals(k.visuals),Array.isArray(k==null?void 0:k.events)&&c.setEvents(k.events);break}case"tick":{const k=E.data;k!=null&&k.status&&c.setStatus(k.status),Array.isArray(k==null?void 0:k.visuals)&&c.setVisuals(k.visuals),k!=null&&k.event&&c.appendEvent(k.event);break}case"event":{const k=E.data;c.appendEvent(k);break}case"status":case"heartbeat":{const k=E.data;c.setStatus(k);break}}},[c]);i.useEffect(()=>((async()=>{await C(),b.current=o.subscribeSSE(u,k=>{console.error("SSE error:",k),d(!1)}),d(!0)})(),()=>{b.current&&(b.current.close(),b.current=null),d(!1)}),[o,u,C]),i.useEffect(()=>{const E=h.current;E&&m(E,l.controls)},[l.controls]);const S=i.useCallback(async()=>{var I,y;const E={};for(const T of((I=l.spec)==null?void 0:I.controls)||[]){if(!me(T))continue;const $=l.controls[T.name]??T.default,P=typeof $=="number"?$:Number(String($));Number.isFinite(P)&&(E[T.name]=P)}for(const T of((y=l.spec)==null?void 0:y.controls)||[]){if(!ae(T))continue;const $=l.controls[T.name]??T.default,P=typeof $=="string"?$:String($);if(P.trim()!=="")try{E[T.name]=JSON.parse(P)}catch(K){console.error("Invalid JSON control:",T.name,K),alert(`Invalid JSON for "${T.label||T.name}". Please fix it and try again.`);return}}const k=Number(E.duration),N=typeof E.tick_dt=="number"?E.tick_dt:void 0;c.setVisuals([]),c.setEvents([]),await o.run(k,N,E)},[o,l.controls,l.spec,c]),R=i.useCallback(async()=>{await o.pause()},[o]),L=i.useCallback(async()=>{await o.resume()},[o]),W=i.useCallback(async()=>{await o.reset(),c.setEvents([])},[o,c]);return e.jsxs(e.Fragment,{children:[e.jsxs("header",{className:"app-header",children:[e.jsxs("div",{className:"app-header-left",children:[e.jsx("button",{className:"btn btn-small lg:hidden",style:{display:window.innerWidth>=1024?"none":"flex",alignItems:"center",justifyContent:"center",padding:"8px"},onClick:()=>w(!g),title:"Toggle controls",children:e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("line",{x1:"3",y1:"12",x2:"21",y2:"12"}),e.jsx("line",{x1:"3",y1:"6",x2:"21",y2:"6"}),e.jsx("line",{x1:"3",y1:"18",x2:"21",y2:"18"})]})}),s,e.jsx("h1",{className:"app-title",children:((q=l.spec)==null?void 0:q.title)||"BioSim UI"})]}),e.jsxs("div",{className:"app-header-right",children:[t,e.jsx("div",{className:"app-status",children:a&&e.jsx("div",{className:"sse-indicator",title:"Stream Connected"})}),e.jsx("button",{className:"btn btn-small lg:hidden",style:{display:window.innerWidth>=1024?"none":"flex",alignItems:"center",justifyContent:"center",padding:"8px"},onClick:()=>v(!j),title:"Toggle events",children:e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10"}),e.jsx("line",{x1:"12",y1:"16",x2:"12",y2:"12"}),e.jsx("line",{x1:"12",y1:"8",x2:"12.01",y2:"8"})]})})]})]}),e.jsx("aside",{className:`app-sidebar-left ${g?"open":""}`,children:e.jsx(et,{onRun:S,onPause:R,onResume:L,onReset:W})}),e.jsx("main",{className:"app-main",children:e.jsx(bt,{chatAdapter:n})}),e.jsx("aside",{className:`app-sidebar-right ${j?"open":""}`,children:e.jsx(jt,{})}),(g||j)&&e.jsx("div",{className:"drawer-backdrop",onClick:()=>{w(!1),v(!1)}})]})}function Mt(){const s=xe();return s.editor?e.jsx(Ct,{api:s}):null}function $t({initialMode:s,editorEnabled:t,headerLeft:n,headerRight:o,chatAdapter:l}){const[c,a]=i.useState(s??"simulation");i.useEffect(()=>{if(!t){a("simulation");return}window.location.hash.slice(1)==="editor"&&a("editor");const w=()=>{const j=window.location.hash.slice(1);a(j==="editor"?"editor":"simulation")};return window.addEventListener("hashchange",w),()=>window.removeEventListener("hashchange",w)},[t]);const d=()=>{if(!t)return;const g=c==="simulation"?"editor":"simulation";window.location.hash=g==="editor"?"editor":"",a(g)};return c==="editor"&&t?e.jsxs("div",{className:"app",style:{height:"100%"},children:[e.jsx("div",{style:{position:"absolute",top:"8px",right:"8px",zIndex:1001},children:e.jsx("button",{onClick:d,style:{padding:"6px 12px",background:"var(--primary)",color:"#fff",border:"none",borderRadius:"4px",cursor:"pointer",fontSize:"13px",boxShadow:"0 2px 4px rgba(0,0,0,0.2)"},children:"Back to Simulation"})}),e.jsx(Mt,{})]}):e.jsxs("div",{className:"app",children:[e.jsx("div",{className:"app-layout",children:e.jsx(kt,{headerLeft:n,headerRight:o,chatAdapter:l})}),t&&e.jsx("div",{style:{position:"fixed",bottom:"16px",right:"16px",zIndex:1e3},children:e.jsxs("button",{onClick:d,title:"Open Config Editor",style:{padding:"10px 16px",background:"var(--primary)",color:"#fff",border:"none",borderRadius:"8px",cursor:"pointer",fontSize:"13px",fontWeight:500,boxShadow:"0 2px 8px rgba(20, 184, 166, 0.4)",display:"flex",alignItems:"center",gap:"6px"},children:[e.jsx("span",{style:{fontSize:"16px"},children:"⚙"}),"Config Editor"]})})]})}function At({initialMode:s,headerLeft:t,headerRight:n,chatAdapter:o}){const c=!!xe().editor;return e.jsx($t,{initialMode:s,editorEnabled:c,headerLeft:t,headerRight:n,chatAdapter:o})}const Rt=({api:s,className:t,style:n,height:o="100vh",initialMode:l,headerLeft:c,headerRight:a,chatAdapter:d})=>{const g=t?`simui-root ${t}`:"simui-root";return e.jsx("div",{className:g,style:{height:o,...n},children:e.jsx(qe,{api:s,children:e.jsx(Ge,{children:e.jsx(At,{initialMode:l,headerLeft:c,headerRight:a,chatAdapter:d})})})})};exports.SimuiApp=Rt;exports.createSimuiApi=He;
