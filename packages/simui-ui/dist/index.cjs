"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const e=require("react/jsx-runtime"),l=require("react"),Ve=require("react-markdown"),Ue=require("remark-gfm"),ge=require("dagre"),O=require("@xyflow/react");function We(s){const t=s.replace(/\/$/,"");async function n(a){const d=await fetch(`${t}${a}`);if(!d.ok)throw new Error(`GET ${a} failed: ${d.status}`);return d.json()}async function o(a,d){const x=await fetch(`${t}${a}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(d)});if(!x.ok)throw new Error(`POST ${a} failed: ${x.status}`);return x.json()}async function i(a,d){const x=await fetch(`${t}${a}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(d)});if(!x.ok)throw new Error(`PUT ${a} failed: ${x.status}`);return x.json()}function c(a,d){const x=new EventSource(`${t}/api/stream`);return x.onmessage=S=>{try{const v=JSON.parse(S.data);a(v)}catch(v){console.error("Failed to parse SSE message:",v)}},x.onerror=S=>{d&&d(S)},{close:()=>x.close()}}return{spec:()=>n("/api/spec"),status:()=>n("/api/status"),state:()=>n("/api/state"),events:(a,d=200)=>n(`/api/events?${new URLSearchParams({...a!=null?{since_id:String(a)}:{},limit:String(d)}).toString()}`),visuals:()=>n("/api/visuals"),snapshot:()=>n("/api/snapshot"),run:(a,d,x)=>o("/api/run",{duration:a,tick_dt:d,...x||{}}),pause:()=>o("/api/pause",{}),resume:()=>o("/api/resume",{}),reset:()=>o("/api/reset",{}),subscribeSSE:c,editor:{getModules:()=>n("/api/editor/modules"),getConfig:a=>n(`/api/editor/config?path=${encodeURIComponent(a)}`),getCurrent:()=>n("/api/editor/current"),saveConfig:(a,d)=>i("/api/editor/config",{path:a,graph:d}),applyConfig:(a,d)=>o("/api/editor/apply",{graph:a,save_path:d}),validate:a=>o("/api/editor/validate",a),layout:a=>o("/api/editor/layout",a),toYaml:a=>o("/api/editor/to-yaml",a),fromYaml:a=>o("/api/editor/from-yaml",{yaml:a}),listFiles:a=>n(`/api/editor/files${a?`?path=${encodeURIComponent(a)}`:""}`)}}}function Ge(){var n;return{baseUrl:((n=window.__BSIM_UI__)==null?void 0:n.mountPath)??""}}const Oe=l.createContext(null),Ye=({api:s,children:t})=>{const n=l.useMemo(Ge,[]),o=l.useMemo(()=>s??We(n.baseUrl),[n.baseUrl,s]);return e.jsx(Oe.Provider,{value:o,children:t})};function be(){const s=l.useContext(Oe);if(!s)throw new Error("useApi must be used within ApiProvider");return s}const Ie=l.createContext(null);function Ke({children:s}){const[t,n]=l.useState(null),[o,i]=l.useState(null),[c,a]=l.useState([]),[d,x]=l.useState([]),[S,v]=l.useState({duration:10,tick_dt:.1}),[w,C]=l.useState(new Set),g=l.useMemo(()=>({setSpec:n,setStatus:i,setVisuals:a,setEvents:x,appendEvent:$=>x(k=>[...k,$]),setControls:$=>v(k=>({...k,...$})),setControlsIfUnset:$=>v(k=>{const u={...k};for(const[j,b]of Object.entries($)){const y=u[j];(!Object.prototype.hasOwnProperty.call(u,j)||y===void 0||y===""||typeof y=="number"&&!Number.isFinite(y))&&(u[j]=b)}return u}),setVisibleModules:C}),[]),f={spec:t,status:o,visuals:c,events:d,controls:S,visibleModules:w},m=l.useMemo(()=>({state:f,actions:g}),[t,o,c,d,S,w,g]);return e.jsx(Ie.Provider,{value:m,children:s})}function se(){const s=l.useContext(Ie);if(!s)throw new Error("useUi must be used within UiProvider");return s}function je(){const{state:s}=se();return l.useMemo(()=>{var c;const t=Array.isArray((c=s.spec)==null?void 0:c.modules)?s.spec.modules:[],n=s.visuals.map(a=>a.module),o=[],i=new Set;for(const a of t)a&&!i.has(a)&&(o.push(a),i.add(a));for(const a of n)a&&!i.has(a)&&(o.push(a),i.add(a));return o},[s.spec,s.visuals])}function qe(){const{state:s}=se();return l.useMemo(()=>{const t=new Map;for(const n of s.visuals){const o=t.get(n.module);o?t.set(n.module,[...o,...n.visuals||[]]):t.set(n.module,n.visuals||[])}return t},[s.visuals])}function ue(s){return s.type==="number"}function ae(s){return s.type==="json"}function Fe(s){if(!Number.isFinite(s))return"â€”";const t=Math.max(0,s),n=Math.floor(t/3600),o=Math.floor(t%3600/60),i=Math.floor(t%60);return n>0?`${n}h ${o}m ${i}s`:o>0?`${o}m ${i}s`:`${i}s`}function Ee({id:s,title:t,summary:n,open:o,onToggle:i,children:c}){return e.jsxs("section",{className:`sidebar-panel ${o?"is-open":"is-closed"}`,children:[e.jsxs("button",{type:"button",className:"sidebar-panel-header",onClick:()=>i(s),"aria-expanded":o,children:[e.jsx("span",{className:`sidebar-panel-chevron ${o?"open":""}`,"aria-hidden":"true",children:"â–¸"}),e.jsx("span",{className:"sidebar-panel-title",children:t}),n&&e.jsx("span",{className:"sidebar-panel-summary",children:n})]}),o&&e.jsx("div",{className:"sidebar-panel-body",children:c})]})}function Xe(){var n;const{state:s}=se(),t=s.status;return t?t.error?e.jsxs("div",{className:"status-display",children:[e.jsx("div",{className:"status-badge status-error",children:"Error"}),e.jsx("div",{className:"status-message error",children:t.error.message})]}):t.running?e.jsxs("div",{className:"status-display",children:[e.jsx("div",{className:`status-badge ${t.paused?"status-paused":"status-running"}`,children:t.paused?"Paused":"Running"}),e.jsxs("div",{className:"status-info",children:["Ticks: ",((n=t.tick_count)==null?void 0:n.toLocaleString())||0]})]}):e.jsx("div",{className:"status-display",children:e.jsx("div",{className:"status-badge status-idle",children:"Idle"})}):e.jsx("div",{className:"status-display",children:e.jsx("div",{className:"status-badge status-unknown",children:"Unknown"})})}function Qe(){var W,L,K;const{state:s,actions:t}=se(),n=s.status,o=(W=s.spec)==null?void 0:W.capabilities,i=(o==null?void 0:o.controls)??!0;i&&(o==null||o.run),i&&(o==null||o.pauseResume),i&&(o==null||o.reset);const c=je(),a=(((L=s.spec)==null?void 0:L.controls)||[]).filter(ue),d=new Set(["wiring","wiring_layout","module_ports","models"]),x=(((K=s.spec)==null?void 0:K.controls)||[]).filter(ae).filter(N=>!d.has(N.name)),S=l.useCallback((N,P)=>t.setControls({[N]:P}),[t]),v=N=>{if(N===""||N===null||N===void 0)return Number.NaN;const P=typeof N=="number"?N:Number(String(N));return Number.isFinite(P)?P:Number.NaN},w=N=>{var P;return(P=a.find(B=>B.name===N))==null?void 0:P.default};v(s.controls.duration??w("duration"));const C=v(s.controls.tick_dt??w("tick_dt")),g=v(n==null?void 0:n.tick_count)*C,f=new Set(["duration","tick_dt"]),m=a.filter(N=>f.has(N.name)),$=a.filter(N=>!f.has(N.name)),k=new Set(c),u=new Map,j=[];for(const N of $){const P=N.name.indexOf(".");if(P>0){const B=N.name.slice(0,P);if(k.has(B)){const U=u.get(B)||[];U.push(N),u.set(B,U);continue}}j.push(N)}const b=Array.from(u.keys()),[y,A]=l.useState({});l.useEffect(()=>{b.length!==0&&A(N=>{const P={...N};for(const B of b)B in P||(P[B]=!1);return P})},[b.join("|")]);const[F,_]=l.useState(!1);return e.jsxs("div",{className:"controls",children:[m.length>0&&e.jsx("div",{className:"control-fields",children:m.map(N=>e.jsxs("div",{className:"control-field",children:[e.jsx("label",{htmlFor:`control-${N.name}`,className:"control-label",children:N.label||N.name}),e.jsx("input",{id:`control-${N.name}`,type:"number",className:"control-input",value:String(s.controls[N.name]??N.default),min:N.min,max:N.max,step:N.step??"any",onChange:P=>S(N.name,P.target.value),disabled:!!(n!=null&&n.running)||!i})]},N.name))}),u.size>0&&e.jsx("div",{className:"control-fields",children:Array.from(u.entries()).map(([N,P])=>e.jsxs("div",{className:"control-group",children:[e.jsxs("button",{type:"button",className:"control-group-header",onClick:()=>A(B=>({...B,[N]:!B[N]})),"aria-expanded":y[N]??!1,children:[e.jsx("span",{className:`control-group-chevron ${y[N]?"open":""}`,"aria-hidden":"true",children:"â–¸"}),e.jsx("span",{className:"control-group-title",children:N}),e.jsxs("span",{className:"control-group-summary",children:[P.length," params"]})]}),y[N]&&e.jsx("div",{className:"control-group-body",children:e.jsx("div",{className:"control-fields",style:{marginTop:0},children:P.map(B=>{const U=B.name.indexOf("."),X=U>0?B.name.slice(U+1):B.name;return e.jsxs("div",{className:"control-field",children:[e.jsx("label",{htmlFor:`control-${B.name}`,className:"control-label",children:B.label||X}),e.jsx("input",{id:`control-${B.name}`,type:"number",className:"control-input",value:String(s.controls[B.name]??B.default),min:B.min,max:B.max,step:B.step??"any",onChange:Z=>S(B.name,Z.target.value),disabled:!!(n!=null&&n.running)||!i})]},B.name)})})})]},N))}),j.length>0&&e.jsx("div",{className:"control-fields",children:j.map(N=>e.jsxs("div",{className:"control-field",children:[e.jsx("label",{htmlFor:`control-${N.name}`,className:"control-label",children:N.label||N.name}),e.jsx("input",{id:`control-${N.name}`,type:"number",className:"control-input",value:String(s.controls[N.name]??N.default),min:N.min,max:N.max,step:N.step??"any",onChange:P=>S(N.name,P.target.value),disabled:!!(n!=null&&n.running)||!i})]},N.name))}),x.length>0&&e.jsxs("div",{className:"control-group",children:[e.jsxs("button",{type:"button",className:"control-group-header",onClick:()=>_(N=>!N),"aria-expanded":F,children:[e.jsx("span",{className:`control-group-chevron ${F?"open":""}`,"aria-hidden":"true",children:"â–¸"}),e.jsx("span",{className:"control-group-title",children:"Advanced (JSON)"}),e.jsxs("span",{className:"control-group-summary",children:[x.length," fields"]})]}),F&&e.jsx("div",{className:"control-group-body",children:e.jsx("div",{className:"control-fields",children:x.map(N=>e.jsxs("div",{className:"control-field",children:[e.jsx("label",{htmlFor:`control-${N.name}`,className:"control-label",children:N.label||N.name}),e.jsx("textarea",{id:`control-${N.name}`,className:"control-input",value:String(s.controls[N.name]??N.default),placeholder:N.placeholder,rows:N.rows??6,onChange:P=>S(N.name,P.target.value),disabled:!!(n!=null&&n.running)||!i})]},N.name))})})]}),e.jsx("div",{className:"control-derived",children:(n==null?void 0:n.running)&&Number.isFinite(g)&&e.jsxs("div",{className:"control-derived-row",children:[e.jsx("span",{className:"control-derived-label",children:"Sim time"}),e.jsx("span",{className:"control-derived-value",children:Fe(g)})]})})]})}function Ze(){const{state:s,actions:t}=se(),n=je();l.useEffect(()=>{n.length>0&&s.visibleModules.size===0&&t.setVisibleModules(new Set(n))},[n,s.visibleModules.size,t]);const o=l.useCallback(a=>{const d=new Set(s.visibleModules);d.has(a)?d.delete(a):d.add(a),t.setVisibleModules(d)},[s.visibleModules,t]),i=l.useCallback(()=>t.setVisibleModules(new Set(n)),[n,t]),c=l.useCallback(()=>t.setVisibleModules(new Set),[t]);return n.length===0?e.jsx("div",{className:"modules",children:e.jsx("div",{className:"empty-state",children:e.jsx("p",{children:"No modules available"})})}):e.jsxs("div",{className:"modules",children:[e.jsx("div",{className:"module-list",children:n.map(a=>e.jsxs("label",{className:"module-item",children:[e.jsx("input",{type:"checkbox",className:"module-checkbox",checked:s.visibleModules.has(a),onChange:()=>o(a)}),e.jsx("span",{className:"module-name",children:a})]},a))}),e.jsxs("div",{className:"module-actions",children:[e.jsx("button",{type:"button",className:"btn btn-small",onClick:i,children:"Show All"}),e.jsx("button",{type:"button",className:"btn btn-small",onClick:c,children:"Hide All"})]})]})}function et(s){const{state:t}=se(),o=je().length,i=t.visibleModules.size||o,[c,a]=l.useState({controls:!1,status:!1,modules:!1}),d=l.useCallback(w=>{a(C=>({...C,[w]:!C[w]}))},[]),x=l.useMemo(()=>{var C;const w=t.status;return w?w.error?"Error":w.running?`${w.paused?"Paused":"Running"} Â· Ticks: ${((C=w.tick_count)==null?void 0:C.toLocaleString())||0}`:"Idle":"Unknown"},[t.status]),S=l.useMemo(()=>{var g;const C=(Array.isArray((g=t.spec)==null?void 0:g.controls)?t.spec.controls:[]).filter(f=>ue(f)||ae(f)).length;return C?`${C} controls`:"No controls"},[t.spec]),v=l.useMemo(()=>o===0?"No modules":`${i}/${o} shown`,[i,o]);return e.jsx("div",{className:"sidebar",children:e.jsxs("div",{className:"sidebar-content",children:[e.jsx(Ee,{id:"status",title:"Status",summary:x,open:c.status,onToggle:d,children:e.jsx(Xe,{})}),e.jsx(Ee,{id:"controls",title:"Controls",summary:S,open:c.controls,onToggle:d,children:e.jsx(Qe,{})}),e.jsx(Ee,{id:"modules",title:"Modules",summary:v,open:c.modules,onToggle:d,children:e.jsx(Ze,{})}),e.jsx(tt,{...s})]})})}function tt({onRun:s,onPause:t,onResume:n,onReset:o}){var m,$;const{state:i}=se(),c=i.status,d=(Array.isArray((m=i.spec)==null?void 0:m.controls)?i.spec.controls:[]).find(k=>ue(k)&&k.name==="duration"),x=d&&ue(d)?d.default:void 0,S=(()=>{const k=i.controls.duration??x,u=typeof k=="number"?k:Number(String(k));return Number.isFinite(u)?u:NaN})(),v=($=i.spec)==null?void 0:$.capabilities,w=(v==null?void 0:v.controls)??!0,C=w&&((v==null?void 0:v.run)??!0),g=w&&((v==null?void 0:v.pauseResume)??!0),f=w&&((v==null?void 0:v.reset)??!0);return e.jsxs("div",{className:"sidebar-actions",children:[e.jsxs("div",{className:"sidebar-actions-row",children:[e.jsx("div",{className:"sidebar-actions-label",children:"Duration"}),e.jsx("div",{className:"sidebar-actions-value",children:Number.isFinite(S)?Fe(S):"â€”"})]}),C&&e.jsx("button",{type:"button",className:"btn btn-primary",onClick:s,disabled:!!(c!=null&&c.running),children:"Run Simulation"}),g&&(c==null?void 0:c.running)&&e.jsx("button",{type:"button",className:"btn btn-secondary",onClick:c.paused?n:t,children:c.paused?"Resume":"Pause"}),f&&e.jsx("button",{type:"button",className:"btn btn-outline",onClick:o,children:"Reset"})]})}function st({data:s,isFullscreen:t}){const x=(s==null?void 0:s.series)||[],{xMin:S,xMax:v,yMin:w,yMax:C}=l.useMemo(()=>{let u=0,j=1,b=0,y=1;for(const A of x){const F=Array.isArray(A==null?void 0:A.points)?A.points:[];for(const _ of F){const W=Number(_==null?void 0:_[0])||0,L=Number(_==null?void 0:_[1])||0;W<u&&(u=W),W>j&&(j=W),L<b&&(b=L),L>y&&(y=L)}}return{xMin:u,xMax:j<=u?u+1:j,yMin:b,yMax:y<=b?b+1:y}},[x]),g=u=>50+(u-S)/(v-S)*450,f=u=>20+(1-(u-w)/(C-w))*180,m=u=>(u.points||[]).map(j=>`${g(j[0])},${f(j[1])}`).join(" "),$=(u,j,b=5)=>Array.from({length:b+1},(y,A)=>u+A*(j-u)/b),k=t?{width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center"}:{};return e.jsx("div",{style:k,className:t?"fullscreen-renderer":"",children:e.jsxs("svg",{viewBox:"0 0 520 240",width:"100%",height:t?"100%":240,preserveAspectRatio:t?"xMidYMid meet":void 0,children:[e.jsx("line",{x1:50,y1:200,x2:500,y2:200,className:"axis"}),e.jsx("line",{x1:50,y1:20,x2:50,y2:200,className:"axis"}),$(S,v,5).map(u=>e.jsxs("g",{children:[e.jsx("line",{x1:g(u),y1:200,x2:g(u),y2:204,className:"tick"}),e.jsx("text",{x:g(u),y:234,className:"ticklbl",textAnchor:"middle",children:u.toFixed(2)})]},`tx-${u}`)),$(w,C,4).map(u=>e.jsxs("g",{children:[e.jsx("line",{x1:46,y1:f(u),x2:50,y2:f(u),className:"tick"}),e.jsx("text",{x:44,y:f(u)+3,className:"ticklbl",textAnchor:"end",children:u.toFixed(2)})]},`ty-${u}`)),x.map((u,j)=>e.jsx("polyline",{points:m(u),fill:"none",stroke:j===0?"#2563eb":j===1?"#dc2626":"#10b981",strokeWidth:2},j))]})})}function nt({data:s,isFullscreen:t}){const x=(s==null?void 0:s.items)||[],S=l.useMemo(()=>{let m=1;for(const $ of x){const k=Number(($==null?void 0:$.value)||0);Number.isFinite(k)&&k>m&&(m=k)}return m},[x]),v=(m,$)=>50+(m+.5)*450/Math.max(1,$),w=m=>Math.max(8,.8*450/Math.max(1,m)),C=m=>20+(1-Math.min(1,Math.max(0,m/S)))*180,g=(m=4)=>Array.from({length:m+1},($,k)=>k*S/m),f=t?{width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center"}:{};return e.jsx("div",{style:f,children:e.jsxs("svg",{viewBox:"0 0 520 240",width:"100%",height:t?"100%":240,preserveAspectRatio:t?"xMidYMid meet":void 0,children:[e.jsx("line",{x1:50,y1:200,x2:500,y2:200,className:"axis"}),e.jsx("line",{x1:50,y1:20,x2:50,y2:200,className:"axis"}),g(4).map(m=>e.jsxs("g",{children:[e.jsx("line",{x1:46,y1:C(m),x2:50,y2:C(m),className:"tick"}),e.jsx("text",{x:44,y:C(m)+3,className:"ticklbl",textAnchor:"end",children:m.toFixed(0)})]},`ty-${m}`)),x.map((m,$)=>e.jsxs("g",{children:[e.jsx("rect",{x:v($,x.length)-w(x.length)/2,y:C(m.value),width:w(x.length),height:200-C(m.value),className:"bar"}),e.jsx("text",{x:v($,x.length),y:234,className:"xlbl",textAnchor:"middle",children:m.label})]},$))]})})}function ot({data:s,isFullscreen:t}){var x,S,v,w;const n=(x=s.columns)!=null&&x.length?s.columns:(S=s.items)!=null&&S.length?Object.keys(s.items[0]):[],o=(v=s.rows)!=null&&v.length?s.rows:((w=s.items)==null?void 0:w.map(C=>n.map(g=>C[g])))||[],i=t?{width:"100%",height:"100%",overflow:"auto"}:{overflow:"auto"},c=t?{width:"100%",borderCollapse:"collapse",fontSize:"16px"}:{width:"100%",borderCollapse:"collapse"},a=t?{textAlign:"left",borderBottom:"1px solid var(--border)",padding:"12px 16px",fontWeight:600,fontSize:"18px"}:{textAlign:"left",borderBottom:"1px solid var(--border)",padding:8,fontWeight:600},d=t?{borderBottom:"1px solid var(--border)",padding:"10px 16px",fontSize:"16px"}:{borderBottom:"1px solid var(--border)",padding:"6px 8px"};return e.jsxs("div",{className:"table-container",style:i,children:[e.jsxs("table",{style:c,children:[e.jsx("thead",{children:e.jsx("tr",{children:n.map(C=>e.jsx("th",{style:a,children:C},C))})}),e.jsx("tbody",{children:o.map((C,g)=>e.jsx("tr",{children:C.map((f,m)=>e.jsx("td",{style:d,children:String(f)},m))},g))})]}),(!n||n.length===0)&&e.jsx("div",{className:"empty",children:"No table data"})]})}function rt({data:s,isFullscreen:t}){if(!(s!=null&&s.src))return e.jsx("div",{className:"empty-state",children:e.jsx("p",{children:"No image"})});const{src:n,alt:o,width:i,height:c}=s;return t?e.jsx("div",{style:{width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center",overflow:"auto"},children:e.jsx("img",{src:n,alt:o||"image",style:{maxWidth:"100%",maxHeight:"100%",objectFit:"contain"}})}):e.jsx("div",{style:{overflow:"auto"},children:e.jsx("img",{src:n,alt:o||"image",width:i,height:c,style:{maxWidth:"100%"}})})}function it({data:s,isFullscreen:t}){const n=s.nodes||[],o=s.edges||[],i=520,c=300,a=110,d=i/2,x=c/2,S=l.useMemo(()=>{const w=Math.max(1,n.length),C=new Map;return n.forEach((g,f)=>{const m=2*Math.PI*f/w;C.set(g.id,{x:d+a*Math.cos(m),y:x+a*Math.sin(m)})}),C},[JSON.stringify(n)]),v=t?{width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center"}:{};return e.jsx("div",{style:v,children:e.jsxs("svg",{viewBox:`0 0 ${i} ${c}`,width:"100%",height:t?"100%":c,preserveAspectRatio:t?"xMidYMid meet":void 0,children:[o.map((w,C)=>{const g=S.get(w.source),f=S.get(w.target);return!g||!f?null:e.jsx("line",{x1:g.x,y1:g.y,x2:f.x,y2:f.y,stroke:"#64748b",strokeWidth:1},C)}),n.map((w,C)=>{const g=S.get(w.id);return g?e.jsxs("g",{children:[e.jsx("circle",{cx:g.x,cy:g.y,r:14,fill:"#22d3ee"}),e.jsx("text",{x:g.x,y:g.y+4,fontSize:10,textAnchor:"middle",fill:"#0f172a",children:w.id})]},w.id):null})]})})}const at={timeseries:st,bar:nt,table:ot,image:rt,graph:it};function lt({isFullscreen:s,onClick:t}){return e.jsx("button",{className:"btn btn-small btn-outline fullscreen-btn",onClick:t,title:s?"Exit fullscreen":"Fullscreen",children:s?e.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"})}):e.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"})})})}function ct({isActive:s,onClick:t}){return e.jsx("button",{className:`btn btn-small btn-outline info-btn ${s?"active":""}`,onClick:t,title:s?"Hide description":"Show description",children:e.jsxs("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10"}),e.jsx("path",{d:"M12 16v-4"}),e.jsx("path",{d:"M12 8h.01"})]})})}function dt({visual:s,index:t}){var g;const[n,o]=l.useState(!1),[i,c]=l.useState(!1),a=at[s.render],d=l.useCallback(()=>{o(f=>!f)},[]),x=l.useCallback(()=>{c(f=>!f)},[]),S=l.useCallback(f=>{f.key==="Escape"&&n&&o(!1)},[n]);if(!a)return e.jsxs("div",{className:"visualization-card error",children:[e.jsxs("div",{className:"card-header",children:[e.jsx("h4",{className:"card-title",children:"Unknown Renderer"}),e.jsx("span",{className:"card-type error",children:s.render})]}),e.jsx("div",{className:"card-content",children:e.jsx("div",{className:"error-message",children:e.jsxs("p",{children:['Renderer type "',s.render,'" is not supported.']})})})]});const v=((g=s.data)==null?void 0:g.title)||`${s.render.charAt(0).toUpperCase()+s.render.slice(1)} #${t+1}`,w=!!s.description,C=e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"card-header",children:[e.jsx("h4",{className:"card-title",children:v}),e.jsxs("div",{className:"card-actions",children:[e.jsx("span",{className:"card-type",children:s.render}),w&&e.jsx(ct,{isActive:i,onClick:x}),e.jsx(lt,{isFullscreen:n,onClick:d})]})]}),i&&s.description&&e.jsx("div",{className:"card-description",children:s.description}),e.jsx("div",{className:"card-content",children:e.jsx(a,{data:s.data,isFullscreen:n})})]});return n?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"visualization-card placeholder"}),e.jsx("div",{className:"fullscreen-overlay",onClick:d,onKeyDown:S,tabIndex:0,children:e.jsx("div",{className:"fullscreen-card",onClick:f=>f.stopPropagation(),children:C})})]}):e.jsx("div",{className:"visualization-card",children:C})}function Be({moduleName:s,visualCount:t}){return e.jsx("header",{className:"module-header",children:e.jsxs("div",{className:"module-info",children:[e.jsx("h3",{className:"module-title",children:s}),e.jsxs("span",{className:"module-meta",children:[t," visualization",t!==1?"s":""]})]})})}function ut({moduleName:s,visuals:t}){return!t||t.length===0?e.jsxs("div",{className:"module-visuals",children:[e.jsx(Be,{moduleName:s,visualCount:0}),e.jsx("div",{className:"empty-state",children:e.jsx("p",{children:"No visualizations available for this module"})})]}):e.jsxs("div",{className:"module-visuals",children:[e.jsx(Be,{moduleName:s,visualCount:t.length}),e.jsx("div",{className:"visualizations-grid",children:t.map((n,o)=>e.jsx(dt,{visual:n,index:o},`${s}-${n.render}-${o}`))})]})}const pt=l.memo(ut);function ze({description:s}){const[t,n]=l.useState(!1);if(!s)return null;const o=s.length>300||s.split(`
`).length>5;return e.jsxs("div",{className:`description-panel ${t?"expanded":"collapsed"}`,children:[e.jsxs("div",{className:"description-header",onClick:()=>o&&n(!t),children:[e.jsxs("div",{className:"description-title",children:[e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"}),e.jsx("polyline",{points:"14 2 14 8 20 8"}),e.jsx("line",{x1:"16",y1:"13",x2:"8",y2:"13"}),e.jsx("line",{x1:"16",y1:"17",x2:"8",y2:"17"}),e.jsx("polyline",{points:"10 9 9 9 8 9"})]}),e.jsx("span",{children:"About this Simulation"})]}),o&&e.jsxs("button",{className:"expand-btn",onClick:i=>{i.stopPropagation(),n(!t)},children:[t?e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("polyline",{points:"18 15 12 9 6 15"})}):e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("polyline",{points:"6 9 12 15 18 9"})}),e.jsx("span",{children:t?"Collapse":"Expand"})]})]}),e.jsx("div",{className:"description-content",children:e.jsx(Ve,{remarkPlugins:[Ue],children:s})})]})}const de="__new__";function ye(s){const t=s.indexOf(".");return t<=0||t>=s.length-1?null:{module:s.slice(0,t),port:s.slice(t+1)}}function Je(s){if(!Array.isArray(s))throw new Error("Wiring must be a JSON array.");return s.filter(t=>t&&typeof t=="object")}function ht(s,t,n,o,i){const c=new Map,a=new Map,d=new Set([...t,...Object.keys(n||{})]);for(const[g,f]of Object.entries(n||{})){c.has(g)||c.set(g,new Set),a.has(g)||a.set(g,new Set);for(const m of f.outputs||[])c.get(g).add(String(m));for(const m of f.inputs||[])a.get(g).add(String(m))}const x=[];let S=0;for(const g of s){const f=typeof g.from=="string"?g.from:"",m=g.to??g.targets,$=typeof m=="string"?[m]:Array.isArray(m)?m:[],k=ye(f);if(k){d.add(k.module),c.has(k.module)||c.set(k.module,new Set),c.get(k.module).add(k.port);for(const u of $){if(typeof u!="string")continue;const j=ye(u);j&&(d.add(j.module),a.has(j.module)||a.set(j.module,new Set),a.get(j.module).add(j.port),S+=1,x.push({id:`w-${S}-${f}->${u}`,source:k.module,sourceHandle:k.port,target:j.module,targetHandle:j.port,type:"smoothstep",style:{stroke:"#6b7280",strokeWidth:2}}))}}}for(const g of o)d.delete(g);const v=new Map(i.map(g=>[g.id,g])),w=Array.from(d).map(g=>{const f=v.get(g),m=Array.from(a.get(g)??[]).sort(),$=Array.from(c.get(g)??[]).sort();return{id:g,type:"wiringNode",position:(f==null?void 0:f.position)??{x:0,y:0},data:{label:g,inputs:m,outputs:$}}}),C=w.length>0&&w.every(g=>g.position.x===0&&g.position.y===0);return{nodes:w,edges:x,needsLayout:C}}function _e(s,t){const n=new ge.graphlib.Graph;n.setDefaultEdgeLabel(()=>({}));const o=220,i=140;n.setGraph({rankdir:"LR",nodesep:40,ranksep:80});for(const c of s)n.setNode(c.id,{width:o,height:i});for(const c of t)n.setEdge(c.source,c.target);return ge.layout(n),s.map(c=>{const a=n.node(c.id);return{...c,position:{x:a.x-o/2,y:a.y-i/2}}})}function mt(s){const t=Je(s),n=[];let o=0;for(const i of t){const c=typeof i.from=="string"?i.from:"",a=i.to??i.targets,d=typeof a=="string"?[a]:Array.isArray(a)?a:[],x=ye(c);if(x)for(const S of d){if(typeof S!="string")continue;const v=ye(S);v&&(o+=1,n.push({id:`w-${o}-${c}->${S}`,source:x.module,sourceHandle:x.port,target:v.module,targetHandle:v.port,type:"smoothstep",style:{stroke:"#6b7280",strokeWidth:2}}))}}return n}function Pe(s){const t=new Map;for(const n of s){if(!n.sourceHandle||!n.targetHandle)continue;const o=`${n.source}.${n.sourceHandle}`,i=`${n.target}.${n.targetHandle}`;t.has(o)||t.set(o,new Set),t.get(o).add(i)}return Array.from(t.entries()).sort(([n],[o])=>n.localeCompare(o)).map(([n,o])=>({from:n,to:Array.from(o).sort()}))}const xt=({data:s,selected:t})=>{const n=t?"var(--warning)":"var(--border)";return e.jsxs("div",{style:{background:"var(--surface-2)",border:`1px solid ${n}`,borderRadius:10,minWidth:200,boxShadow:t?"0 0 0 2px rgba(234, 179, 8, 0.3)":"var(--shadow)",overflow:"hidden",fontFamily:"ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, sans-serif"},children:[e.jsx("div",{style:{padding:"10px 12px",background:"var(--surface)",borderBottom:"1px solid var(--border)",fontWeight:700,fontSize:13,color:"var(--text)"},children:s.label}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",gap:10,padding:"10px 8px 12px 8px"},children:[e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:6},children:[e.jsx("div",{style:{paddingLeft:6,fontSize:11,color:"var(--muted)",fontWeight:600},children:"Inputs"}),s.inputs.length===0?e.jsx("div",{style:{paddingLeft:6,fontSize:11,color:"var(--muted)",fontStyle:"italic"},children:"none"}):s.inputs.map(o=>e.jsxs("div",{style:{position:"relative",paddingLeft:18},children:[e.jsx(O.Handle,{type:"target",position:O.Position.Left,id:o,style:{width:10,height:10,left:-5,background:"#6b7280",border:"2px solid var(--surface-2)"}}),e.jsx("span",{style:{fontSize:12,color:"var(--text)",whiteSpace:"nowrap"},children:o})]},o)),e.jsxs("div",{style:{position:"relative",paddingLeft:18,opacity:.85},children:[e.jsx(O.Handle,{type:"target",position:O.Position.Left,id:de,style:{width:10,height:10,left:-5,background:"var(--warning)",border:"2px solid var(--surface-2)"}}),e.jsx("span",{style:{fontSize:12,color:"var(--muted)",whiteSpace:"nowrap"},children:"+ add"})]})]}),e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:6,alignItems:"flex-end"},children:[e.jsx("div",{style:{paddingRight:6,fontSize:11,color:"var(--muted)",fontWeight:600},children:"Outputs"}),s.outputs.length===0?e.jsx("div",{style:{paddingRight:6,fontSize:11,color:"var(--muted)",fontStyle:"italic"},children:"none"}):s.outputs.map(o=>e.jsxs("div",{style:{position:"relative",paddingRight:18},children:[e.jsx("span",{style:{fontSize:12,color:"var(--text)",whiteSpace:"nowrap"},children:o}),e.jsx(O.Handle,{type:"source",position:O.Position.Right,id:o,style:{width:10,height:10,right:-5,background:"var(--primary)",border:"2px solid var(--surface-2)"}})]},o)),e.jsxs("div",{style:{position:"relative",paddingRight:18,opacity:.85},children:[e.jsx("span",{style:{fontSize:12,color:"var(--muted)",whiteSpace:"nowrap"},children:"+ add"}),e.jsx(O.Handle,{type:"source",position:O.Position.Right,id:de,style:{width:10,height:10,right:-5,background:"var(--warning)",border:"2px solid var(--surface-2)"}})]})]})]})]})};function ft(){var E,T,D,Q;const s=be(),{state:t,actions:n}=se(),o=l.useMemo(()=>{var p;return(((p=t.spec)==null?void 0:p.controls)??[]).find(h=>ae(h)&&h.name==="wiring")},[t.spec]),i=l.useMemo(()=>{var p;return(((p=t.spec)==null?void 0:p.controls)??[]).find(h=>ae(h)&&h.name==="wiring_layout")},[t.spec]),c=l.useMemo(()=>{var p;return(((p=t.spec)==null?void 0:p.controls)??[]).find(h=>ae(h)&&h.name==="module_ports")},[t.spec]),a=l.useMemo(()=>{var p;return(((p=t.spec)==null?void 0:p.controls)??[]).find(h=>ae(h)&&h.name==="models")},[t.spec]),[d,x]=l.useState(!1),[S,v]=l.useState(null),[w,C]=l.useState(!1),[g,f]=l.useState(""),[m,$]=l.useState(null),k=l.useRef(""),u=l.useRef(""),j=!!((E=t.status)!=null&&E.running),[b,y]=l.useState("simui:wiring:default");l.useEffect(()=>{let r=!0;return(async()=>{var h,R,z;try{const H=await s.state();if(!r)return;const I=(h=H==null?void 0:H.run)==null?void 0:h.id;if(typeof I=="string"&&I){y(`simui:wiring:run:${I}`);return}const V=H==null?void 0:H.target,Y=V==null?void 0:V.spaceId,oe=V==null?void 0:V.spaceCommit;if(typeof Y=="string"&&Y){y(`simui:wiring:draft:space:${Y}:${oe||"head"}`);return}const te=V==null?void 0:V.modelId,fe=V==null?void 0:V.modelCommit;if(typeof te=="string"&&te){y(`simui:wiring:draft:model:${te}:${fe||"head"}`);return}const ie=((R=t.spec)==null?void 0:R.title)||"default";y(`simui:wiring:title:${ie}`)}catch{const H=((z=t.spec)==null?void 0:z.title)||"default";y(`simui:wiring:title:${H}`)}})(),()=>{r=!1}},[s,(T=t.spec)==null?void 0:T.title]);const A=l.useMemo(()=>{if(!o)return null;const r=t.controls.wiring;return r===void 0?String(o.default??"[]"):typeof r=="string"?r:String(r)},[t.controls.wiring,o]),F=l.useMemo(()=>{if(!i)return null;const r=t.controls.wiring_layout;return r===void 0?String(i.default??'{"version":1,"nodes":{},"hidden_modules":[]}'):typeof r=="string"?r:String(r)},[t.controls.wiring_layout,i]),_=l.useMemo(()=>{if(!c)return null;const r=t.controls.module_ports;return r===void 0?String(c.default??"{}"):typeof r=="string"?r:String(r)},[t.controls.module_ports,c]),W=l.useMemo(()=>{if(!a)return null;const r=t.controls.models;return r===void 0?String(a.default??"[]"):typeof r=="string"?r:String(r)},[t.controls.models,a]),L=l.useMemo(()=>{if(!_)return{};try{const r=JSON.parse(_);return!r||typeof r!="object"||Array.isArray(r)?{}:r}catch{return{}}},[_]),K=l.useRef(null);l.useEffect(()=>{if(!a||K.current)return;const r=String(a.default??"[]");try{const p=JSON.parse(r);if(!Array.isArray(p))return;const h=new Map;p.forEach((R,z)=>{if(!R||typeof R!="object")return;const H=String(R.alias??R.repo_full_name??R.repo??`module-${z+1}`);H&&h.set(H,R)}),K.current=h}catch{}},[a]);const N=l.useMemo(()=>{const r=new Map;if(!W)return r;try{const p=JSON.parse(W);if(!Array.isArray(p))return r;p.forEach((h,R)=>{if(!h||typeof h!="object")return;const z=String(h.alias??h.repo_full_name??h.repo??`module-${R+1}`);z&&r.set(z,h)})}catch{}return r},[W]),P=l.useMemo(()=>{if(!a)return null;const r=K.current;return r?Array.from(r.keys()).sort((p,h)=>p.localeCompare(h)):null},[a]),B=l.useMemo(()=>{const r={version:1,nodes:{},hidden_modules:[]};if(!F)return r;try{const p=JSON.parse(F);if(!p||typeof p!="object"||Array.isArray(p))return r;const h=p.nodes,R=p.hidden_modules;return{version:typeof p.version=="number"?p.version:1,nodes:h&&typeof h=="object"&&!Array.isArray(h)?h:{},hidden_modules:Array.isArray(R)?R.map(String):[]}}catch{return r}},[F]);l.useEffect(()=>{if(!o)return;const r={};if(t.controls.wiring===void 0){const p=(()=>{try{const h=localStorage.getItem(b);if(!h)return null;const R=JSON.parse(h);return!R||typeof R.wiring!="string"?null:R.wiring}catch{return null}})();r.wiring=p??String(o.default??"[]")}i&&t.controls.wiring_layout===void 0&&(r.wiring_layout=String(i.default??'{"version":1,"nodes":{},"hidden_modules":[]}')),c&&t.controls.module_ports===void 0&&(r.module_ports=String(c.default??"{}")),a&&t.controls.models===void 0&&(r.models=String(a.default??"[]")),Object.keys(r).length>0&&n.setControls(r)},[n,a,c,t.controls,b,o,i]);const[U,X]=l.useState([]),[Z,J]=l.useState([]),ve=l.useMemo(()=>({wiringNode:xt}),[]),q=l.useCallback(r=>{if(i)n.setControls({wiring_layout:JSON.stringify(r,null,2)});else try{localStorage.setItem(`${b}:layout`,JSON.stringify(r))}catch{}},[n,b,i]),G=l.useCallback(()=>{const r={version:1,nodes:{},hidden_modules:[]};if(i)return B;try{const p=localStorage.getItem(`${b}:layout`);if(!p)return r;const h=JSON.parse(p);return!h||typeof h!="object"||Array.isArray(h)?r:{version:typeof h.version=="number"?h.version:1,nodes:h.nodes&&typeof h.nodes=="object"?h.nodes:{},hidden_modules:Array.isArray(h.hidden_modules)?h.hidden_modules.map(String):[]}}catch{return r}},[B,b,i]),pe=l.useMemo(()=>i?B:G(),[B,G,i]),re=l.useMemo(()=>new Set(pe.hidden_modules||[]),[pe.hidden_modules]),he=l.useCallback(r=>{a&&n.setControls({models:JSON.stringify(r,null,2)})},[n,a]);l.useEffect(()=>{if(!A)return;const r=`${A}@@${F??""}@@${_??""}`;if(r!==u.current){u.current=r;try{const p=JSON.parse(A),h=Je(p);v(null),X(R=>{var fe;const z=G(),{nodes:H,edges:I,needsLayout:V}=ht(h,Array.isArray((fe=t.spec)==null?void 0:fe.modules)?t.spec.modules.map(String):[],L,new Set(z.hidden_modules||[]),R),Y=H.map(ie=>{const le=(z.nodes||{})[ie.id];return le?{...ie,position:{x:le.x,y:le.y}}:ie});J(I);const oe=V&&Object.keys(z.nodes||{}).length===0,te=oe?_e(Y,I):Y;if(oe){const ie={};for(const le of te)ie[le.id]={x:le.position.x,y:le.position.y};q({...z,nodes:ie,hidden_modules:z.hidden_modules||[],version:1})}return te}),w||f(A)}catch(p){const h=p instanceof Error?p.message:String(p);v(h),f(A)}}},[_,L,G,w,t.spec,q,F,A]);const ne=l.useCallback(r=>{const p=Pe(r),h=JSON.stringify(p,null,2);k.current=h,n.setControls({wiring:h}),f(h),v(null);try{localStorage.setItem(b,JSON.stringify({wiring:h,updatedAt:Date.now()}))}catch{}},[n,b]),ce=l.useCallback((r,p,h)=>{if(X(R=>R.map(z=>{if(z.id!==r)return z;const H=z.data,I=p==="input"?"inputs":"outputs",V=H[I];if(V.includes(h))return z;const Y={...H,[I]:[...V,h].sort()};return{...z,data:Y}})),!!c)try{const R=_?JSON.parse(_):{},z=R&&typeof R=="object"&&!Array.isArray(R)?R:{},H=z[r],I=H&&typeof H=="object"&&!Array.isArray(H)?{...H}:{},V=p==="input"?"inputs":"outputs",Y=Array.isArray(I[V])?I[V].map(String):[];Y.includes(h)||Y.push(h),Y.sort((oe,te)=>oe.localeCompare(te)),I[V]=Y,z[r]=I,n.setControls({module_ports:JSON.stringify(z,null,2)})}catch{}},[n,c,_]),Se=l.useCallback(r=>{X(p=>{const h=O.applyNodeChanges(r,p);if(r.some(z=>z.type==="position"||z.type==="dimensions")){const z={};for(const I of h)z[I.id]={x:I.position.x,y:I.position.y};const H=G();q({...H,nodes:{...H.nodes||{},...z},hidden_modules:H.hidden_modules||[],version:1})}return h})},[G,q]),we=l.useCallback(r=>{const p=r.some(h=>h.type==="remove"||h.type==="add");J(h=>{const R=O.applyEdgeChanges(r,h);return p&&ne(R),R})},[ne]),Ne=l.useCallback(()=>{if(!m)return;const r=m.sourcePort.trim(),p=m.targetPort.trim();if(r.includes(".")||p.includes(".")){v('Port names must not include "."');return}!r||!p||(ce(m.source,"output",r),ce(m.target,"input",p),J(h=>{const R=O.addEdge({id:`e-${Date.now()}`,source:m.source,sourceHandle:r,target:m.target,targetHandle:p,type:"smoothstep",style:{stroke:"#6b7280",strokeWidth:2}},h);return ne(R),R}),$(null))},[ce,m,ne]),Ce=l.useCallback(r=>{if(j||!r.source||!r.target)return;let p=r.sourceHandle,h=r.targetHandle;if(!(!p||!h)){if(p===de){$({source:r.source,target:r.target,sourceHandle:p,targetHandle:h,sourcePort:"",targetPort:h===de?"":String(h),mode:h===de?"both":"from"});return}if(h===de){$({source:r.source,target:r.target,sourceHandle:p,targetHandle:h,sourcePort:String(p),targetPort:"",mode:"to"});return}J(R=>{const z=O.addEdge({...r,sourceHandle:p,targetHandle:h,id:`e-${Date.now()}`,type:"smoothstep",style:{stroke:"#6b7280",strokeWidth:2}},R);return ne(z),z})}},[j,ce,ne]),ke=l.useCallback(()=>{try{const r=JSON.parse(g),p=JSON.stringify(Pe(mt(r)),null,2);k.current=p,n.setControls({wiring:p}),v(null),C(!1);try{localStorage.setItem(b,JSON.stringify({wiring:p,updatedAt:Date.now()}))}catch{}}catch(r){const p=r instanceof Error?r.message:String(r);v(p),x(!0),C(!0)}},[n,g,b]),Me=l.useCallback(()=>{X(r=>{const p=_e(r,Z),h={};for(const z of p)h[z.id]={x:z.position.x,y:z.position.y};const R=G();return q({...R,nodes:{...R.nodes||{},...h},hidden_modules:R.hidden_modules||[],version:1}),p})},[Z,G,q]),$e=l.useCallback(()=>{const r=G();q({...r,nodes:{},hidden_modules:r.hidden_modules||[],version:1}),X(p=>p.map(h=>({...h,position:{x:0,y:0}})))},[G,q]),me=l.useMemo(()=>Z.filter(r=>!re.has(r.source)&&!re.has(r.target)),[Z,re]),Ae=U.length,Re=me.length,xe=l.useMemo(()=>{var p;const r=new Set;for(const h of Array.isArray((p=t.spec)==null?void 0:p.modules)?t.spec.modules:[])r.add(String(h));for(const h of Object.keys(L||{}))r.add(String(h));for(const h of U)r.add(String(h.id));return Array.from(r).sort((h,R)=>h.localeCompare(R))},[U,L,t.spec]),ee=l.useCallback(r=>{const p=G(),h=new Set(p.hidden_modules||[]);h.has(r)?h.delete(r):h.add(r),q({...p,hidden_modules:Array.from(h).sort(),version:1,nodes:p.nodes||{}})},[G,q]),M=l.useCallback(r=>{if(!a)return;const p=K.current;if(!p)return;const h=G(),R=new Set(h.hidden_modules||[]);if(N.get(r)){const V=Array.from(N.entries()).filter(([Y])=>Y!==r).map(([,Y])=>Y);he(V),R.add(r),q({...h,hidden_modules:Array.from(R).sort(),nodes:h.nodes||{},version:1}),J(Y=>{const oe=Y.filter(te=>te.source!==r&&te.target!==r);return ne(oe),oe});return}const H=p.get(r);if(!H)return;const I=[...Array.from(N.values()),H];he(I),R.delete(r),q({...h,hidden_modules:Array.from(R).sort(),nodes:h.nodes||{},version:1})},[N,a,G,he,ne,q]);return o?e.jsxs("div",{className:`wiring-panel ${d?"expanded":"collapsed"}`,children:[e.jsxs("div",{className:"wiring-header",onClick:()=>x(r=>!r),children:[e.jsxs("div",{className:"wiring-title",children:[e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M9 18h6"}),e.jsx("path",{d:"M10 22h4"}),e.jsx("path",{d:"M12 2v10"}),e.jsx("path",{d:"M5 12h14"}),e.jsx("circle",{cx:"12",cy:"12",r:"3"})]}),e.jsx("span",{children:"Wiring"}),e.jsxs("span",{className:"wiring-meta",children:[Ae," modules Â· ",Re," connections"]}),re.size>0&&e.jsxs("span",{className:"wiring-meta",children:[re.size," hidden"]}),j&&e.jsx("span",{className:"wiring-locked",children:"locked while running"})]}),e.jsx("div",{className:"wiring-actions",children:e.jsx("button",{className:"expand-btn",onClick:r=>{r.stopPropagation(),x(p=>!p)},children:d?"Collapse":"Expand"})})]}),S&&e.jsxs("div",{className:"wiring-error",children:[e.jsxs("span",{children:["Invalid wiring JSON: ",S]}),e.jsx("button",{className:"btn btn-small btn-outline",onClick:()=>{x(!0),C(!0)},children:"Edit JSON"})]}),d&&e.jsxs("div",{className:"wiring-body",children:[e.jsx("div",{className:"wiring-canvas",children:e.jsxs(O.ReactFlow,{nodes:U,edges:me,onNodesChange:Se,onEdgesChange:we,onConnect:Ce,nodeTypes:ve,fitView:!0,snapToGrid:!0,snapGrid:[15,15],nodesDraggable:!j,nodesConnectable:!j,elementsSelectable:!j,deleteKeyCode:j?null:["Backspace","Delete"],style:{background:"var(--bg)"},children:[e.jsx(O.Background,{gap:20,size:1,color:"var(--border)"}),e.jsx(O.Controls,{style:{background:"var(--surface)",border:"1px solid var(--border)",borderRadius:6}})]})}),e.jsxs("div",{className:"wiring-advanced",children:[e.jsxs("div",{style:{display:"flex",gap:8,justifyContent:"space-between",flexWrap:"wrap"},children:[e.jsxs("div",{style:{display:"flex",gap:8},children:[e.jsx("button",{className:"btn btn-small btn-outline",onClick:Me,children:"Auto layout"}),e.jsx("button",{className:"btn btn-small btn-outline",onClick:$e,children:"Reset layout"})]}),e.jsx("button",{className:"btn btn-small btn-outline",onClick:()=>C(r=>!r),children:w?"Hide JSON":"Show JSON"})]}),xe.length>0&&e.jsxs("div",{className:"wiring-palette",children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:8},children:[e.jsx("div",{style:{fontSize:12,color:"var(--muted)",fontWeight:600},children:"Modules"}),e.jsx("div",{style:{fontSize:11,color:"var(--muted)"},children:"diagram only"})]}),e.jsx("div",{className:"wiring-palette-list",children:xe.map(r=>{const p=re.has(r);return e.jsxs("label",{className:"wiring-palette-item",children:[e.jsx("input",{type:"checkbox",checked:!p,onChange:()=>ee(r),disabled:j}),e.jsx("span",{style:{color:p?"var(--muted)":"var(--text)"},children:r})]},r)})})]}),P&&P.length>0&&e.jsxs("div",{className:"wiring-palette",children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:8},children:[e.jsx("div",{style:{fontSize:12,color:"var(--muted)",fontWeight:600},children:"Run Composition"}),e.jsx("div",{style:{fontSize:11,color:"var(--muted)"},children:"affects run"})]}),e.jsx("div",{className:"wiring-palette-list",children:P.map(r=>{const p=N.has(r);return e.jsxs("label",{className:"wiring-palette-item",children:[e.jsx("input",{type:"checkbox",checked:p,onChange:()=>M(r),disabled:j}),e.jsx("span",{style:{color:p?"var(--text)":"var(--muted)"},children:r})]},r)})})]}),w&&e.jsxs("div",{className:"wiring-json",children:[e.jsx("textarea",{className:"control-input",value:g,onChange:r=>f(r.target.value),rows:10,disabled:j}),e.jsxs("div",{className:"wiring-json-actions",children:[e.jsx("button",{className:"btn btn-small btn-primary",onClick:ke,disabled:j,children:"Apply"}),e.jsx("button",{className:"btn btn-small btn-outline",onClick:()=>{f(A??"[]"),v(null)},children:"Reset"})]})]})]})]}),m&&e.jsx("div",{className:"wiring-modal-backdrop",onClick:()=>$(null),role:"presentation",children:e.jsxs("div",{className:"wiring-modal",onClick:r=>r.stopPropagation(),children:[e.jsx("div",{className:"wiring-modal-title",children:"Add connection"}),e.jsxs("div",{className:"wiring-modal-subtitle",children:[m.source," â†’ ",m.target]}),e.jsxs("div",{className:"wiring-modal-grid",children:[e.jsxs("label",{className:"wiring-modal-field",children:[e.jsx("span",{children:"From (output port)"}),e.jsx("input",{className:"control-input",value:m.sourcePort,onChange:r=>$(p=>p&&{...p,sourcePort:r.target.value}),placeholder:"e.g. population_state",disabled:j||m.mode==="to",list:`wiring-ports-out-${m.source}`})]}),e.jsxs("label",{className:"wiring-modal-field",children:[e.jsx("span",{children:"To (input port)"}),e.jsx("input",{className:"control-input",value:m.targetPort,onChange:r=>$(p=>p&&{...p,targetPort:r.target.value}),placeholder:"e.g. prey_state",disabled:j||m.mode==="from",list:`wiring-ports-in-${m.target}`})]})]}),e.jsx("datalist",{id:`wiring-ports-out-${m.source}`,children:(((D=U.find(r=>r.id===m.source))==null?void 0:D.data.outputs)??[]).map(r=>e.jsx("option",{value:String(r)},String(r)))}),e.jsx("datalist",{id:`wiring-ports-in-${m.target}`,children:(((Q=U.find(r=>r.id===m.target))==null?void 0:Q.data.inputs)??[]).map(r=>e.jsx("option",{value:String(r)},String(r)))}),e.jsxs("div",{className:"wiring-modal-actions",children:[e.jsx("button",{className:"btn btn-outline",onClick:()=>$(null),children:"Cancel"}),e.jsx("button",{className:"btn btn-primary",onClick:Ne,disabled:j,children:"Add"})]})]})})]}):null}function gt(s){const t=new Date(s);return Number.isNaN(t.getTime())?"":t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}function yt({adapter:s}){const[t,n]=l.useState([]),[o,i]=l.useState(!0),[c,a]=l.useState(null),[d,x]=l.useState(""),[S,v]=l.useState(!1),w=l.useRef(null);l.useEffect(()=>{let f=!0;return i(!0),s.getThread().then(m=>{f&&(n(m.messages??[]),a(null))}).catch(m=>{f&&a(m instanceof Error?m.message:String(m))}).finally(()=>{f&&i(!1)}),()=>{f=!1}},[s]),l.useEffect(()=>{var f;(f=w.current)==null||f.scrollIntoView({behavior:"smooth"})},[t.length]);const C=async()=>{const f=d.trim();if(!f||S)return;x(""),v(!0),a(null);const m=new Date().toISOString(),$={id:`local-user-${Date.now()}`,role:"user",content:f,createdAt:m},k=`local-assistant-${Date.now()}`,u={id:k,role:"assistant",content:"",createdAt:m};n(j=>[...j,$,u]);try{const j=await s.sendMessage({content:f,onChunk:b=>{b&&n(y=>y.map(A=>A.id===k?{...A,content:A.content+b}:A))}});n(b=>b.map(y=>y.id===k?j:y))}catch(j){const b=j instanceof Error?j.message:String(j);a(b),n(y=>y.filter(A=>A.id!==k))}finally{v(!1)}},g=f=>{f.key==="Enter"&&!f.shiftKey&&(f.preventDefault(),C())};return e.jsxs("div",{className:"chat-panel",children:[e.jsx("div",{className:"chat-header",children:e.jsxs("div",{children:[e.jsx("div",{className:"chat-title",children:"Simulation Chat"}),e.jsx("div",{className:"chat-subtitle",children:"Shared across related runs."})]})}),o&&e.jsx("div",{className:"chat-loading",children:"Loading chat historyâ€¦"}),c&&e.jsx("div",{className:"chat-error",children:c}),e.jsxs("div",{className:`chat-messages ${t.length===0?"empty":""}`,children:[t.length===0&&!o&&e.jsx("div",{className:"chat-empty",children:"Start a conversation about this simulation."}),t.map(f=>e.jsxs("div",{className:`chat-message ${f.role==="user"?"user":"assistant"}`,children:[e.jsx("div",{className:"chat-bubble",children:f.content}),e.jsx("div",{className:"chat-meta",children:gt(f.createdAt)})]},f.id)),e.jsx("div",{ref:w})]}),e.jsxs("div",{className:"chat-input",children:[e.jsx("textarea",{className:"chat-textarea",placeholder:"Ask about parameters, outputs, or model behaviorâ€¦",value:d,onChange:f=>x(f.target.value),onKeyDown:g,rows:2,disabled:S}),e.jsx("button",{type:"button",className:"btn btn-primary",onClick:C,disabled:S||!d.trim(),children:S?"Sendingâ€¦":"Send"})]})]})}function De({message:s,description:t}){return e.jsx("div",{className:"empty-state",children:e.jsxs("div",{className:"empty-content",children:[e.jsx("h3",{children:s}),t&&e.jsx("p",{children:t})]})})}function bt({chatAdapter:s}){var w;const{state:t}=se(),n=je(),o=l.useMemo(()=>t.visibleModules.size?n.filter(C=>t.visibleModules.has(C)):n,[n,t.visibleModules]),i=qe(),c=(w=t.spec)==null?void 0:w.description,a=!!s,d=l.useMemo(()=>{var C,g;return!!((g=(C=t.spec)==null?void 0:C.controls)!=null&&g.some(f=>f.type==="json"&&f.name==="wiring"))},[t.spec]),[x,S]=l.useState("visuals"),v=n.length===0?e.jsxs(e.Fragment,{children:[c&&e.jsx(ze,{description:c}),e.jsx(De,{message:"No modules found",description:"The simulation doesn't have any modules to display yet."})]}):o.length===0?e.jsxs(e.Fragment,{children:[c&&e.jsx(ze,{description:c}),e.jsx(De,{message:"No modules selected",description:"Select modules from the sidebar to view their visualizations."})]}):e.jsxs(e.Fragment,{children:[c&&e.jsx(ze,{description:c}),e.jsx("div",{className:"modules-grid",children:o.map(C=>e.jsx(pt,{moduleName:C,visuals:i.get(C)||[]},C))})]});return e.jsxs("div",{className:"main-content",children:[e.jsxs("div",{className:"main-tabs",children:[e.jsx("button",{type:"button",className:`main-tab ${x==="visuals"?"active":""}`,onClick:()=>S("visuals"),children:"Visualizations"}),d&&e.jsx("button",{type:"button",className:`main-tab ${x==="wiring"?"active":""}`,onClick:()=>S("wiring"),children:"Wiring"}),a&&e.jsx("button",{type:"button",className:`main-tab ${x==="chat"?"active":""}`,onClick:()=>S("chat"),children:"Chat"})]}),x==="chat"&&s&&e.jsx(yt,{adapter:s}),x==="wiring"&&d&&e.jsx(ft,{}),x==="visuals"&&v]})}function jt(){const{state:s,actions:t}=se(),n=s.events||[],o=l.useRef(null),[i,c]=l.useState(!0);l.useEffect(()=>{i&&o.current&&(o.current.scrollTop=o.current.scrollHeight)},[n,i]);const a=()=>{if(!o.current)return;const{scrollTop:d,scrollHeight:x,clientHeight:S}=o.current,v=d+S>=x-10;c(v)};return e.jsx("div",{className:"footer",children:e.jsxs("div",{className:"footer-content",children:[e.jsxs("header",{className:"footer-header",children:[e.jsxs("div",{className:"footer-title-section",children:[e.jsx("h2",{className:"footer-title",children:"Event Log"}),e.jsx("div",{className:"event-stats",children:e.jsxs("div",{className:"stat-item",children:[e.jsx("span",{className:"stat-label",children:"Total:"}),e.jsx("span",{className:"stat-value",children:n.length})]})})]}),e.jsx("div",{className:"footer-actions",children:n.length>0&&e.jsx("button",{className:"btn btn-small btn-outline",onClick:()=>t.setEvents([]),children:"Clear"})})]}),e.jsx("div",{className:"footer-body",children:n.length===0?e.jsx("div",{className:"event-list empty",children:e.jsx("div",{className:"empty-state",children:e.jsx("p",{children:"No events recorded yet"})})}):e.jsxs("div",{className:"event-list-container",children:[e.jsxs("div",{className:"event-list-header",children:[e.jsxs("span",{className:"event-count",children:[n.length," event",n.length!==1?"s":""]}),e.jsxs("div",{className:"event-controls",children:[e.jsx("button",{className:`btn btn-small ${i?"active":""}`,onClick:()=>c(!i),title:i?"Auto-scroll enabled":"Auto-scroll disabled",children:"ðŸ“Œ"}),e.jsx("button",{className:"btn btn-small",onClick:()=>{o.current&&(o.current.scrollTop=o.current.scrollHeight,c(!0))},title:"Scroll to bottom",children:"â¬‡ï¸"})]})]}),e.jsx("div",{ref:o,className:"event-list",onScroll:a,children:n.slice().reverse().map(d=>e.jsxs("div",{className:"event-item",children:[e.jsx("time",{className:"event-timestamp",dateTime:d.ts,children:d.ts}),e.jsx("div",{className:"event-message",children:d.event})]},d.id))})]})})]})})}const vt=({data:s,selected:t})=>{const n=s,{label:o,moduleType:i,inputs:c,outputs:a}=n,d=i.split(".").pop()||i,x=i.includes(".neuro.")?"neuro":i.includes(".ecology.")?"ecology":"custom",v={neuro:{bg:"#1a2744",border:"#3b82f6",header:"#2563eb",text:"#e0f2fe"},ecology:{bg:"#14352a",border:"#22c55e",header:"#16a34a",text:"#dcfce7"},custom:{bg:"#2e1a47",border:"#a855f7",header:"#9333ea",text:"#f3e8ff"}}[x];return e.jsxs("div",{className:"module-node",style:{background:v.bg,border:`2px solid ${t?"#fbbf24":v.border}`,borderRadius:"10px",minWidth:"180px",boxShadow:t?"0 0 0 2px #fbbf24":"0 4px 16px rgba(0,0,0,0.5)",fontFamily:"ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, sans-serif"},children:[e.jsx("div",{style:{background:v.header,color:"#fff",padding:"10px 14px",borderRadius:"8px 8px 0 0",fontWeight:600,fontSize:"14px",letterSpacing:"0.01em"},children:o}),e.jsx("div",{style:{padding:"6px 14px",fontSize:"12px",color:v.text,borderBottom:`1px solid ${v.border}50`,opacity:.85},children:d}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",padding:"10px 0"},children:[e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"6px"},children:[c.map(w=>e.jsxs("div",{style:{position:"relative",paddingLeft:"14px"},children:[e.jsx(O.Handle,{type:"target",position:O.Position.Left,id:w,style:{width:"12px",height:"12px",background:"#6b7280",border:"2px solid #1a2744",left:"-6px"}}),e.jsx("span",{style:{fontSize:"12px",color:v.text,fontWeight:500},children:w})]},w)),c.length===0&&e.jsx("div",{style:{paddingLeft:"14px",fontSize:"12px",color:"#9aa6c1",fontStyle:"italic"},children:"no inputs"})]}),e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"6px",alignItems:"flex-end"},children:[a.map(w=>e.jsxs("div",{style:{position:"relative",paddingRight:"14px"},children:[e.jsx("span",{style:{fontSize:"12px",color:v.text,fontWeight:500},children:w}),e.jsx(O.Handle,{type:"source",position:O.Position.Right,id:w,style:{width:"12px",height:"12px",background:v.header,border:"2px solid #1a2744",right:"-6px"}})]},w)),a.length===0&&e.jsx("div",{style:{paddingRight:"14px",fontSize:"12px",color:"#9aa6c1",fontStyle:"italic"},children:"no outputs"})]})]})]})},St=l.memo(vt),wt=({registry:s,onDragStart:t})=>{const[n,o]=l.useState(new Set(["neuro","ecology"])),[i,c]=l.useState(""),a="#0f1628",d="#11182b",x="#e6eaf2",S="#9aa6c1",v="#1e2a44";if(!s)return e.jsx("div",{className:"module-palette",style:{padding:"16px",background:d,color:S},children:e.jsx("div",{children:"Loading modules..."})});const w=f=>{const m=new Set(n);m.has(f)?m.delete(f):m.add(f),o(m)},C={neuro:"#3b82f6",ecology:"#22c55e",custom:"#a855f7"},g=Object.entries(s.categories).map(([f,m])=>{const $=m.map(k=>({path:k,spec:s.modules[k]})).filter(({spec:k})=>{var j;if(!k)return!1;if(!i)return!0;const u=i.toLowerCase();return k.name.toLowerCase().includes(u)||((j=k.description)==null?void 0:j.toLowerCase().includes(u))||f.toLowerCase().includes(u)});return{category:f,modules:$}}).filter(({modules:f})=>f.length>0);return e.jsxs("div",{className:"module-palette",style:{height:"100%",display:"flex",flexDirection:"column",background:d,fontFamily:"ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, sans-serif"},children:[e.jsxs("div",{style:{padding:"14px",borderBottom:`1px solid ${v}`},children:[e.jsx("h3",{style:{margin:"0 0 10px 0",fontSize:"14px",fontWeight:600,color:x},children:"Modules"}),e.jsx("input",{type:"text",placeholder:"Search modules...",value:i,onChange:f=>c(f.target.value),style:{width:"100%",padding:"8px 12px",border:`1px solid ${v}`,borderRadius:"8px",fontSize:"13px",background:a,color:x}})]}),e.jsxs("div",{style:{flex:1,overflow:"auto",padding:"8px"},children:[g.map(({category:f,modules:m})=>e.jsxs("div",{style:{marginBottom:"8px"},children:[e.jsxs("button",{onClick:()=>w(f),style:{width:"100%",display:"flex",alignItems:"center",gap:"8px",padding:"10px",background:"none",border:"none",cursor:"pointer",fontSize:"13px",fontWeight:600,color:x,textAlign:"left"},children:[e.jsx("span",{style:{transform:n.has(f)?"rotate(90deg)":"rotate(0deg)",transition:"transform 0.2s",color:S},children:"â–¶"}),e.jsx("span",{style:{width:"10px",height:"10px",borderRadius:"50%",background:C[f]||"#666"}}),f.charAt(0).toUpperCase()+f.slice(1),e.jsx("span",{style:{marginLeft:"auto",fontSize:"12px",color:S},children:m.length})]}),n.has(f)&&e.jsx("div",{style:{paddingLeft:"16px"},children:m.map(({path:$,spec:k})=>e.jsxs("div",{draggable:!0,onDragStart:u=>t(u,$,k),style:{padding:"10px 12px",marginBottom:"6px",background:a,border:`1px solid ${v}`,borderRadius:"8px",cursor:"grab",fontSize:"13px"},title:k.description||$,children:[e.jsx("div",{style:{fontWeight:500,color:x},children:k.name}),e.jsxs("div",{style:{fontSize:"11px",color:S,marginTop:"4px"},children:[k.inputs.length>0&&e.jsxs("span",{children:["in: ",k.inputs.join(", ")]}),k.inputs.length>0&&k.outputs.length>0&&" | ",k.outputs.length>0&&e.jsxs("span",{children:["out: ",k.outputs.join(", ")]})]})]},$))})]},f)),g.length===0&&e.jsx("div",{style:{padding:"16px",textAlign:"center",color:S,fontSize:"13px"},children:"No modules found"})]}),e.jsx("div",{style:{padding:"10px 14px",borderTop:`1px solid ${v}`,fontSize:"12px",color:S},children:"Drag modules to canvas"})]})},Nt=({selectedNode:s,registry:t,onUpdateNode:n,onDeleteNode:o,onRenameNode:i})=>{const c="#0f1628",a="#11182b",d="#e6eaf2",x="#9aa6c1",S="#1e2a44",v="#22d3ee";if(!s)return e.jsxs("div",{className:"properties-panel",style:{padding:"16px",background:a,color:x,fontFamily:"ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, sans-serif"},children:[e.jsx("h3",{style:{margin:"0 0 10px 0",fontSize:"14px",fontWeight:600,color:d},children:"Properties"}),e.jsx("p",{style:{fontSize:"13px",color:x},children:"Select a node to edit its properties"})]});const w=s.data,C=t==null?void 0:t.modules[w.moduleType],g=(u,j)=>{const b={...w.args,[u]:j};n(s.id,b)},f=u=>{const j=u.target.value.trim();j&&j!==s.id&&i(s.id,j)},m=(u,j)=>{if(j==="int"||j==="float"||j==="number"){const b=parseFloat(u);return isNaN(b)?0:b}if(j==="bool"||j==="boolean")return u==="true"||u==="1";if(j==="list"||j==="List")try{return JSON.parse(u)}catch{return[]}return u},$=u=>u==null?"":typeof u=="object"?JSON.stringify(u):String(u),k={width:"100%",padding:"8px 12px",border:`1px solid ${S}`,borderRadius:"8px",fontSize:"13px",background:c,color:d};return e.jsxs("div",{className:"properties-panel",style:{height:"100%",display:"flex",flexDirection:"column",background:a,fontFamily:"ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, sans-serif"},children:[e.jsx("div",{style:{padding:"14px",borderBottom:`1px solid ${S}`},children:e.jsx("h3",{style:{margin:"0",fontSize:"14px",fontWeight:600,color:d},children:"Properties"})}),e.jsxs("div",{style:{flex:1,overflow:"auto",padding:"14px"},children:[e.jsxs("div",{style:{marginBottom:"18px"},children:[e.jsx("label",{style:{display:"block",fontSize:"12px",fontWeight:500,marginBottom:"6px",color:d},children:"Node ID"}),e.jsx("input",{type:"text",defaultValue:s.id,onBlur:f,onKeyDown:u=>{u.key==="Enter"&&u.currentTarget.blur()},style:k})]}),e.jsxs("div",{style:{marginBottom:"18px"},children:[e.jsx("label",{style:{display:"block",fontSize:"12px",fontWeight:500,marginBottom:"6px",color:d},children:"Module Type"}),e.jsx("div",{style:{padding:"8px 12px",background:c,borderRadius:"8px",fontSize:"12px",color:x,border:`1px solid ${S}`},children:w.moduleType})]}),(C==null?void 0:C.description)&&e.jsx("div",{style:{marginBottom:"18px",padding:"10px",background:"#0c2135",borderRadius:"8px",fontSize:"12px",color:v,border:`1px solid ${S}`},children:C.description.split(`
`)[0]}),e.jsxs("div",{style:{marginBottom:"10px"},children:[e.jsx("label",{style:{display:"block",fontSize:"12px",fontWeight:600,marginBottom:"10px",color:d},children:"Arguments"}),C==null?void 0:C.args.map(u=>{const j=w.args[u.name]??u.default,b=u.type==="bool"||u.type==="boolean"?"checkbox":"text";return e.jsxs("div",{style:{marginBottom:"14px"},children:[e.jsxs("label",{style:{display:"flex",alignItems:"center",gap:"6px",fontSize:"12px",marginBottom:"6px",color:x},children:[e.jsx("span",{style:{fontWeight:500,color:d},children:u.name}),e.jsxs("span",{style:{color:x},children:["(",u.type,")"]}),u.required&&e.jsx("span",{style:{color:"#ef4444"},children:"*"})]}),b==="checkbox"?e.jsx("input",{type:"checkbox",checked:!!j,onChange:y=>g(u.name,y.target.checked),style:{width:"18px",height:"18px",accentColor:v}}):u.options?e.jsx("select",{value:String(j),onChange:y=>g(u.name,m(y.target.value,u.type)),style:k,children:u.options.map(y=>e.jsx("option",{value:String(y),children:String(y)},String(y)))}):e.jsx("input",{type:"text",value:$(j),onChange:y=>g(u.name,m(y.target.value,u.type)),placeholder:u.default!==null?`Default: ${$(u.default)}`:"",style:k}),u.description&&e.jsx("div",{style:{fontSize:"11px",color:x,marginTop:"4px"},children:u.description})]},u.name)}),(!C||C.args.length===0)&&e.jsx("div",{style:{fontSize:"13px",color:x,fontStyle:"italic"},children:"No configurable arguments"})]}),e.jsxs("div",{style:{marginTop:"18px",paddingTop:"18px",borderTop:`1px solid ${S}`},children:[e.jsx("label",{style:{display:"block",fontSize:"12px",fontWeight:600,marginBottom:"10px",color:d},children:"Ports"}),e.jsxs("div",{style:{display:"flex",gap:"20px"},children:[e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:"12px",color:x,marginBottom:"6px"},children:"Inputs"}),w.inputs.length>0?w.inputs.map(u=>e.jsx("div",{style:{fontSize:"12px",color:d},children:u},u)):e.jsx("div",{style:{fontSize:"12px",color:x,fontStyle:"italic"},children:"none"})]}),e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:"12px",color:x,marginBottom:"6px"},children:"Outputs"}),w.outputs.length>0?w.outputs.map(u=>e.jsx("div",{style:{fontSize:"12px",color:d},children:u},u)):e.jsx("div",{style:{fontSize:"12px",color:x,fontStyle:"italic"},children:"none"})]})]})]})]}),e.jsx("div",{style:{padding:"14px",borderTop:`1px solid ${S}`},children:e.jsx("button",{onClick:()=>o(s.id),style:{width:"100%",padding:"10px",background:"#3b1c1c",border:"1px solid #7f1d1d",borderRadius:"8px",color:"#fca5a5",fontSize:"13px",fontWeight:500,cursor:"pointer"},children:"Delete Node"})})]})},Te=(s,t,n="LR")=>{const o=new ge.graphlib.Graph;o.setDefaultEdgeLabel(()=>({}));const i=200,c=120;return o.setGraph({rankdir:n,nodesep:50,ranksep:100}),s.forEach(d=>{o.setNode(d.id,{width:i,height:c})}),t.forEach(d=>{o.setEdge(d.source,d.target)}),ge.layout(o),{nodes:s.map(d=>{const x=o.node(d.id);return{...d,position:{x:x.x-i/2,y:x.y-c/2}}}),edges:t}},He=(s,t)=>{const n=s.nodes.map(i=>{const c=t==null?void 0:t.modules[i.type];return{id:i.id,type:"moduleNode",position:i.position,data:{label:i.id,moduleType:i.type,args:i.data.args,inputs:i.data.inputs.length>0?i.data.inputs:(c==null?void 0:c.inputs)||[],outputs:i.data.outputs.length>0?i.data.outputs:(c==null?void 0:c.outputs)||[]}}}),o=s.edges.map(i=>({id:i.id,source:i.source,sourceHandle:i.sourceHandle,target:i.target,targetHandle:i.targetHandle,type:"smoothstep",animated:!1,style:{stroke:"#6b7280",strokeWidth:2}}));return{nodes:n,edges:o}},Le=(s,t,n)=>{const o=s.map(c=>{const a=c.data;return{id:c.id,type:a.moduleType,position:c.position,data:{args:a.args,inputs:a.inputs,outputs:a.outputs}}}),i=t.map(c=>({id:c.id,source:c.source,sourceHandle:c.sourceHandle||"",target:c.target,targetHandle:c.targetHandle||""}));return{nodes:o,edges:i,meta:n}},Ct=({api:s,initialConfigPath:t})=>{const n=s.editor,[o,i,c]=O.useNodesState([]),[a,d,x]=O.useEdgesState([]),[S,v]=l.useState(null),[w,C]=l.useState(null),[g,f]=l.useState(t||""),[m,$]=l.useState({}),[k,u]=l.useState(!1),[j,b]=l.useState(null),[y,A]=l.useState([]),[F,_]=l.useState(!t),[W,L]=l.useState(!1),[K,N]=l.useState(""),P=l.useRef(null),B="#0f1628",U="#11182b",X="#e6eaf2",Z="#9aa6c1",J="#1e2a44",ve="#3b82f6",q=l.useMemo(()=>({moduleNode:St}),[]),[G,pe]=l.useState(!1);l.useEffect(()=>{(async()=>{try{const[E,T]=await Promise.all([n.getModules(),n.getCurrent()]);if(v(E),T.available&&T.graph){const{nodes:D,edges:Q}=He(T.graph,E);if(D.every(p=>p.position.x===0&&p.position.y===0)&&D.length>0){const p=Te(D,Q);i(p.nodes),d(p.edges)}else i(D),d(Q);$(T.graph.meta),f(T.path||""),u(!1),_(!1)}else{const D=await n.listFiles();A(D),_(!0)}}catch(E){console.error("Failed to initialize editor:",E),n.listFiles().then(A).catch(console.error)}})()},[s,i,d]);const re=l.useCallback(async M=>{try{b(null);const E=await n.getConfig(M),{nodes:T,edges:D}=He(E,S);if(T.every(r=>r.position.x===0&&r.position.y===0)&&T.length>0){const r=Te(T,D);i(r.nodes),d(r.edges)}else i(T),d(D);$(E.meta),f(M),u(!1),_(!1)}catch(E){b(`Failed to load config: ${E}`)}},[s,S,i,d]),he=l.useCallback(async()=>{if(!g){b("No config path specified");return}try{const M=Le(o,a,m);await n.saveConfig(g,M),u(!1),b(null)}catch(M){b(`Failed to save: ${M}`)}},[s,g,o,a,m]),ne=l.useCallback(async()=>{if(!g){b("No config path specified");return}pe(!0);try{const M=Le(o,a,m),E=await n.applyConfig(M,g);E.ok?(u(!1),b(null),b("Configuration applied successfully!"),setTimeout(()=>b(null),3e3)):b(`Failed to apply: ${E.error||"Unknown error"}`)}catch(M){b(`Failed to apply config: ${M}`)}finally{pe(!1)}},[s,g,o,a,m]),ce=l.useCallback(()=>{const M=Te(o,a);i(M.nodes),d(M.edges),u(!0)},[o,a,i,d]),Se=l.useCallback(M=>{const E={...M,id:`e${Date.now()}`,type:"smoothstep",style:{stroke:"#6b7280",strokeWidth:2}};d(T=>O.addEdge(E,T)),u(!0)},[d]),we=l.useCallback(({nodes:M})=>{C(M.length===1?M[0]:null)},[]),Ne=l.useCallback(()=>{u(!0)},[]),Ce=l.useCallback(M=>{M.preventDefault(),M.dataTransfer.dropEffect="move"},[]),ke=l.useCallback(M=>{M.preventDefault();const E=M.dataTransfer.getData("application/moduleType"),T=M.dataTransfer.getData("application/moduleSpec");if(!E||!T)return;const D=JSON.parse(T),Q=P.current;if(!Q)return;const r=Q.getBoundingClientRect(),p={x:M.clientX-r.left-100,y:M.clientY-r.top-50};let h=D.name.toLowerCase().replace(/[^a-z0-9]/g,"_"),R=1,z=h;for(;o.some(I=>I.id===z);)z=`${h}_${R++}`;const H={id:z,type:"moduleNode",position:p,data:{label:z,moduleType:E,args:{},inputs:D.inputs,outputs:D.outputs}};i(I=>[...I,H]),u(!0)},[o,i]),Me=l.useCallback((M,E,T)=>{M.dataTransfer.setData("application/moduleType",E),M.dataTransfer.setData("application/moduleSpec",JSON.stringify(T)),M.dataTransfer.effectAllowed="move"},[]),$e=l.useCallback((M,E)=>{i(T=>T.map(D=>D.id===M?{...D,data:{...D.data,args:E}}:D)),u(!0)},[i]),me=l.useCallback(M=>{i(E=>E.filter(T=>T.id!==M)),d(E=>E.filter(T=>T.source!==M&&T.target!==M)),C(null),u(!0)},[i,d]),Ae=l.useCallback((M,E)=>{if(o.some(T=>T.id===E&&T.id!==M)){b(`Node ID "${E}" already exists`);return}i(T=>T.map(D=>D.id===M?{...D,id:E,data:{...D.data,label:E}}:D)),d(T=>T.map(D=>{const Q={...D};return D.source===M&&(Q.source=E),D.target===M&&(Q.target=E),Q})),C(T=>(T==null?void 0:T.id)===M?{...T,id:E}:T),u(!0)},[o,i,d]),Re=l.useCallback(()=>{i([]),d([]),$({title:"New Configuration"}),f(""),u(!0),_(!1)},[i,d]),xe=l.useCallback(async()=>{try{const M=Le(o,a,m),E=await n.toYaml(M);N(E.yaml),L(!0)}catch(M){b(`Failed to generate YAML: ${M}`)}},[s,o,a,m]),ee={padding:"6px 12px",border:`1px solid ${J}`,borderRadius:"6px",background:U,color:X,cursor:"pointer",fontSize:"13px",fontWeight:500};return e.jsxs("div",{style:{display:"flex",height:"100vh",width:"100%",background:B},children:[e.jsx("div",{style:{width:"240px",borderRight:`1px solid ${J}`,background:U},children:e.jsx(wt,{registry:S,onDragStart:Me})}),e.jsxs("div",{style:{flex:1,display:"flex",flexDirection:"column"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px",padding:"8px 12px",borderBottom:`1px solid ${J}`,background:U},children:[e.jsx("button",{onClick:()=>_(!0),style:ee,children:"Open"}),e.jsx("button",{onClick:Re,style:ee,children:"New"}),e.jsx("button",{onClick:he,disabled:!k||!g,style:{...ee,background:k&&g?ve:J,color:k&&g?"#fff":Z,cursor:k&&g?"pointer":"not-allowed"},children:"Save"}),e.jsx("button",{onClick:ne,disabled:G||!g,style:{...ee,background:g&&!G?"#22c55e":J,color:g&&!G?"#fff":Z,cursor:g&&!G?"pointer":"not-allowed"},children:G?"Applying...":"Apply to Simulation"}),e.jsx("div",{style:{width:"1px",height:"20px",background:J}}),e.jsx("button",{onClick:ce,style:ee,children:"Auto Layout"}),e.jsx("button",{onClick:xe,style:ee,children:"View YAML"}),e.jsx("div",{style:{flex:1}}),g&&e.jsxs("span",{style:{fontSize:"12px",color:Z},children:[g,k&&e.jsx("span",{style:{color:"#f59e0b"},children:" (unsaved)"})]})]}),j&&e.jsxs("div",{style:{padding:"8px 12px",background:j.includes("success")?"#14352a":"#3b1c1c",borderBottom:`1px solid ${j.includes("success")?"#22c55e":"#7f1d1d"}`,color:j.includes("success")?"#86efac":"#fca5a5",fontSize:"13px"},children:[j,e.jsx("button",{onClick:()=>b(null),style:{marginLeft:"8px",background:"none",border:"none",cursor:"pointer",color:j.includes("success")?"#86efac":"#fca5a5"},children:"âœ•"})]}),e.jsx("div",{ref:P,style:{flex:1,background:B},onDragOver:Ce,onDrop:ke,children:e.jsxs(O.ReactFlow,{nodes:o,edges:a,onNodesChange:c,onEdgesChange:x,onConnect:Se,onSelectionChange:we,onNodeDragStop:Ne,nodeTypes:q,fitView:!0,snapToGrid:!0,snapGrid:[15,15],deleteKeyCode:["Backspace","Delete"],onNodesDelete:()=>u(!0),onEdgesDelete:()=>u(!0),style:{background:B},children:[e.jsx(O.Background,{variant:O.BackgroundVariant.Dots,gap:20,size:1,color:J}),e.jsx(O.Controls,{style:{background:U,border:`1px solid ${J}`,borderRadius:"6px"}}),e.jsx(O.MiniMap,{nodeColor:M=>{const E=M.data;return E.moduleType.includes(".neuro.")?"#3b82f6":E.moduleType.includes(".ecology.")?"#22c55e":"#a855f7"},maskColor:"rgba(11, 16, 32, 0.7)",style:{background:U,border:`1px solid ${J}`,borderRadius:"6px"}}),m.title&&e.jsx(O.Panel,{position:"top-center",children:e.jsx("div",{style:{padding:"6px 14px",background:U,borderRadius:"6px",border:`1px solid ${J}`,fontSize:"14px",fontWeight:600,color:X},children:m.title})})]})})]}),e.jsx("div",{style:{width:"280px",borderLeft:`1px solid ${J}`,background:U},children:e.jsx(Nt,{selectedNode:w,registry:S,onUpdateNode:$e,onDeleteNode:me,onRenameNode:Ae})}),F&&e.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(0,0,0,0.7)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e3},onClick:()=>_(!1),children:e.jsxs("div",{style:{background:U,borderRadius:"10px",border:`1px solid ${J}`,width:"400px",maxHeight:"500px",overflow:"hidden",display:"flex",flexDirection:"column",boxShadow:"0 8px 32px rgba(0,0,0,0.4)"},onClick:M=>M.stopPropagation(),children:[e.jsx("div",{style:{padding:"16px",borderBottom:`1px solid ${J}`},children:e.jsx("h3",{style:{margin:0,fontSize:"16px",color:X,fontWeight:600},children:"Open Configuration"})}),e.jsxs("div",{style:{flex:1,overflow:"auto",padding:"8px"},children:[y.map(M=>e.jsxs("div",{onClick:()=>{M.is_dir?n.listFiles(M.path).then(A):re(M.path)},style:{padding:"10px 12px",cursor:"pointer",borderRadius:"6px",display:"flex",alignItems:"center",gap:"8px",color:X,fontSize:"13px"},onMouseOver:E=>E.currentTarget.style.background=B,onMouseOut:E=>E.currentTarget.style.background="transparent",children:[e.jsx("span",{children:M.is_dir?"ðŸ“":"ðŸ“„"}),e.jsx("span",{children:M.name})]},M.path)),y.length===0&&e.jsx("div",{style:{padding:"16px",textAlign:"center",color:Z,fontSize:"13px"},children:"No config files found"})]}),e.jsx("div",{style:{padding:"12px",borderTop:`1px solid ${J}`,display:"flex",justifyContent:"flex-end"},children:e.jsx("button",{onClick:()=>_(!1),style:ee,children:"Cancel"})})]})}),W&&e.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(0,0,0,0.7)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e3},onClick:()=>L(!1),children:e.jsxs("div",{style:{background:U,borderRadius:"10px",border:`1px solid ${J}`,width:"600px",maxHeight:"80vh",overflow:"hidden",display:"flex",flexDirection:"column",boxShadow:"0 8px 32px rgba(0,0,0,0.4)"},onClick:M=>M.stopPropagation(),children:[e.jsxs("div",{style:{padding:"16px",borderBottom:`1px solid ${J}`,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx("h3",{style:{margin:0,fontSize:"16px",color:X,fontWeight:600},children:"YAML Preview"}),e.jsx("button",{onClick:()=>{navigator.clipboard.writeText(K)},style:{...ee,padding:"4px 12px",fontSize:"12px"},children:"Copy"})]}),e.jsx("pre",{style:{flex:1,overflow:"auto",padding:"16px",margin:0,background:B,color:X,fontSize:"12px",fontFamily:"ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace",lineHeight:1.5},children:K}),e.jsx("div",{style:{padding:"12px",borderTop:`1px solid ${J}`,display:"flex",justifyContent:"flex-end"},children:e.jsx("button",{onClick:()=>L(!1),style:ee,children:"Close"})})]})})]})};function kt({headerLeft:s,headerRight:t,chatAdapter:n}){var j;const o=be(),{state:i,actions:c}=se(),[a,d]=l.useState(!1),x=l.useRef(null),S=l.useRef(null),v=b=>{if(typeof window>"u")return null;try{const y=window.sessionStorage.getItem(b);if(!y)return null;const A=JSON.parse(y);return!A||typeof A!="object"?null:A}catch{return null}},w=(b,y)=>{if(!(typeof window>"u"))try{window.sessionStorage.setItem(b,JSON.stringify(y))}catch{}},C=async()=>{try{const b=await o.state(),y=b==null?void 0:b.target,A=b==null?void 0:b.run,F=(y==null?void 0:y.modelId)??(A==null?void 0:A.model_id)??(A==null?void 0:A.modelId),_=(y==null?void 0:y.spaceId)??(A==null?void 0:A.project_id)??(A==null?void 0:A.spaceId);if(F)return`simui-controls:model:${F}`;if(_)return`simui-controls:space:${_}`}catch{}return"simui-controls:generic"},g=l.useCallback(async()=>{const b=await o.spec();c.setSpec(b);const y={},A=new Set;for(const L of b.controls||[])ue(L)&&(A.add(L.name),y[L.name]=L.default),ae(L)&&(A.add(L.name),y[L.name]=String(L.default??""));const F=await C();S.current=F;const _=v(F),W={};if(_)for(const[L,K]of Object.entries(_))A.has(L)&&(W[L]=K);c.setControls({...y,...W})},[o,c]),f=l.useCallback(b=>{switch(b.type){case"snapshot":{const y=b.data;y!=null&&y.status&&c.setStatus(y.status),Array.isArray(y==null?void 0:y.visuals)&&c.setVisuals(y.visuals),Array.isArray(y==null?void 0:y.events)&&c.setEvents(y.events);break}case"tick":{const y=b.data;y!=null&&y.status&&c.setStatus(y.status),Array.isArray(y==null?void 0:y.visuals)&&c.setVisuals(y.visuals),y!=null&&y.event&&c.appendEvent(y.event);break}case"event":{const y=b.data;c.appendEvent(y);break}case"status":case"heartbeat":{const y=b.data;c.setStatus(y);break}}},[c]);l.useEffect(()=>((async()=>{await g(),x.current=o.subscribeSSE(f,y=>{console.error("SSE error:",y),d(!1)}),d(!0)})(),()=>{x.current&&(x.current.close(),x.current=null),d(!1)}),[o,f,g]),l.useEffect(()=>{const b=S.current;b&&w(b,i.controls)},[i.controls]);const m=l.useCallback(async()=>{var F,_;const b={};for(const W of((F=i.spec)==null?void 0:F.controls)||[]){if(!ue(W))continue;const L=i.controls[W.name]??W.default,K=typeof L=="number"?L:Number(String(L));Number.isFinite(K)&&(b[W.name]=K)}for(const W of((_=i.spec)==null?void 0:_.controls)||[]){if(!ae(W))continue;const L=i.controls[W.name]??W.default,K=typeof L=="string"?L:String(L);if(K.trim()!=="")try{b[W.name]=JSON.parse(K)}catch(N){console.error("Invalid JSON control:",W.name,N),alert(`Invalid JSON for "${W.label||W.name}". Please fix it and try again.`);return}}const y=Number(b.duration),A=typeof b.tick_dt=="number"?b.tick_dt:void 0;c.setVisuals([]),c.setEvents([]),await o.run(y,A,b)},[o,i.controls,i.spec,c]),$=l.useCallback(async()=>{await o.pause()},[o]),k=l.useCallback(async()=>{await o.resume()},[o]),u=l.useCallback(async()=>{await o.reset(),c.setEvents([])},[o,c]);return e.jsxs(e.Fragment,{children:[e.jsxs("header",{className:"app-header",children:[e.jsxs("div",{className:"app-header-left",children:[s,e.jsx("h1",{className:"app-title",children:((j=i.spec)==null?void 0:j.title)||"BioSim UI"})]}),e.jsxs("div",{className:"app-header-right",children:[t,e.jsx("div",{className:"app-status",children:a&&e.jsx("div",{className:"sse-indicator",title:"Stream Connected"})})]})]}),e.jsx("aside",{className:"app-sidebar-left",children:e.jsx(et,{onRun:m,onPause:$,onResume:k,onReset:u})}),e.jsx("main",{className:"app-main",children:e.jsx(bt,{chatAdapter:n})}),e.jsx("aside",{className:"app-sidebar-right",children:e.jsx(jt,{})})]})}function Mt(){const s=be();return s.editor?e.jsx(Ct,{api:s}):null}function $t({initialMode:s,editorEnabled:t,headerLeft:n,headerRight:o,chatAdapter:i}){const[c,a]=l.useState(s??"simulation");l.useEffect(()=>{if(!t){a("simulation");return}window.location.hash.slice(1)==="editor"&&a("editor");const S=()=>{const v=window.location.hash.slice(1);a(v==="editor"?"editor":"simulation")};return window.addEventListener("hashchange",S),()=>window.removeEventListener("hashchange",S)},[t]);const d=()=>{if(!t)return;const x=c==="simulation"?"editor":"simulation";window.location.hash=x==="editor"?"editor":"",a(x)};return c==="editor"&&t?e.jsxs("div",{className:"app",style:{height:"100%"},children:[e.jsx("div",{style:{position:"absolute",top:"8px",right:"8px",zIndex:1001},children:e.jsx("button",{onClick:d,style:{padding:"6px 12px",background:"#3b82f6",color:"#fff",border:"none",borderRadius:"4px",cursor:"pointer",fontSize:"13px",boxShadow:"0 2px 4px rgba(0,0,0,0.2)"},children:"Back to Simulation"})}),e.jsx(Mt,{})]}):e.jsxs("div",{className:"app",children:[e.jsx("div",{className:"app-layout",children:e.jsx(kt,{headerLeft:n,headerRight:o,chatAdapter:i})}),t&&e.jsx("div",{style:{position:"fixed",bottom:"16px",right:"16px",zIndex:1e3},children:e.jsxs("button",{onClick:d,title:"Open Config Editor",style:{padding:"10px 16px",background:"#3b82f6",color:"#fff",border:"none",borderRadius:"8px",cursor:"pointer",fontSize:"13px",fontWeight:500,boxShadow:"0 2px 8px rgba(59, 130, 246, 0.4)",display:"flex",alignItems:"center",gap:"6px"},children:[e.jsx("span",{style:{fontSize:"16px"},children:"âš™"}),"Config Editor"]})})]})}function At({initialMode:s,headerLeft:t,headerRight:n,chatAdapter:o}){const c=!!be().editor;return e.jsx($t,{initialMode:s,editorEnabled:c,headerLeft:t,headerRight:n,chatAdapter:o})}const Rt=({api:s,className:t,style:n,height:o="100vh",initialMode:i,headerLeft:c,headerRight:a,chatAdapter:d})=>{const x=t?`simui-root ${t}`:"simui-root";return e.jsx("div",{className:x,style:{height:o,...n},children:e.jsx(Ye,{api:s,children:e.jsx(Ke,{children:e.jsx(At,{initialMode:i,headerLeft:c,headerRight:a,chatAdapter:d})})})})};exports.SimuiApp=Rt;exports.createSimuiApi=We;
